<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="iOS å¼€å‘ å…¬å¸åˆä¼™äºº | æéœ²é‘«ï¼ŒiOS & Photography Loverï¼ŒSoftware Engineerï¼ŒEntrepreneur | è¿™é‡Œæ˜¯ ä¸€ä¹‹ç¬” @Yizibbi æéœ²é‘« çš„ä¸ªäººåšå®¢ï¼Œ ç”Ÿæ´»éœ€è¦ä»ªå¼æ„Ÿï¼ŒğŸ’ªã€‚">
    <meta name="keywords"  content="æéœ²é‘«, Yizibi,yizibi,ä¸€ä¹‹ç¬”çš„åšå®¢,ä¸€ä¹‹ç¬”,ä¸€æ”¯ç¬”, iOS, å…¬å¸åˆä¼™äºº, @yizibi, @yizibiçš„åšå®¢, åšå®¢, ä¸ªäººç½‘ç«™, äº’è”ç½‘">
    <meta name="theme-color" content="#000000">
    
    <!-- Open Graph -->
    <meta property="og:title" content="RabbitMQåœ¨iOSä¸­çš„åº”ç”¨ - ä¸€ä¹‹ç¬”çš„åšå®¢ | Yizibi Blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="æ–‡ç« åŸåˆ›å¦‚éœ€è½¬è½½ï¼Œè¯·æ³¨æ˜å‡ºå¤„â€æœ¬æ–‡é¦–å‘äºä¸€ä¹‹ç¬”â€;

">
    
    <meta property="article:published_time" content="2018-08-14T06:32:24Z">
    
    
    <meta property="article:author" content="ä¸€ä¹‹ç¬”">
    
    
    <meta property="article:tag" content="iOSæŠ€æœ¯">
    
    
    <meta property="og:image" content="http://localhost:4000/img/avatar-hux-ny.jpg">
    <meta property="og:url" content="http://localhost:4000/2018/08/14/RabbitMQ%E5%9C%A8iOS%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/">
    <meta property="og:site_name" content="ä¸€ä¹‹ç¬”çš„åšå®¢ | Yizibi Blog">
    
    <title>RabbitMQåœ¨iOSä¸­çš„åº”ç”¨ - ä¸€ä¹‹ç¬”çš„åšå®¢ | Yizibi Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/2018/08/14/RabbitMQ%E5%9C%A8iOS%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>

<script type="text/javascript" color="238,205,205" opacity='0.7' zIndex="-2" count="99" src="../../../../js/canvas-nest.min.js"></script>
<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">ä¸€ä¹‹ç¬”</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    
                    <li>
                        <a href="/archive/">Archive</a>
                    </li>
                    
                    <li>
                        <a href="/portfolio/">Portfolio</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/home-bg-o.jpg" width="0" height="0"> -->

<!-- Post Header -->
<!-- canvas-nest.min.js -->
<!--<script type="text/javascript" src="../../../../js/canvas-nest.min.js"></script>-->
<head>
    <link href="../../../../css/rouge.css" rel="stylesheet">
</head>
<script type="text/javascript" color="238,205,205" opacity='0.7' zIndex="-2" count="99" src="../../../../js/canvas-nest.min.js"></script>
<!--//æ·»åŠ è¯„è®ºç³»ç»Ÿ-->
<link rel="stylesheet" href="../../../../css/gitalk.css">
    <script src="../../../../js/gitalk.min.js"></script>
<!--    æ‰“èµ-->
<link href="/css/reward.css?v=6.2.0" rel="stylesheet" type="text/css" />

<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/home-bg-o.jpg')
    }

    
</style>
<header class="intro-header" >
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#iOSæŠ€æœ¯" title="iOSæŠ€æœ¯">iOSæŠ€æœ¯</a>
                        
                    </div>
                    <h1>RabbitMQåœ¨iOSä¸­çš„åº”ç”¨</h1>
                    
                    
                    <h2 class="subheading">RabbitMQ</h2>
                    
                    <span class="meta">Posted by ä¸€ä¹‹ç¬” on August 14, 2018</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                


				<p>æ–‡ç« åŸåˆ›å¦‚éœ€è½¬è½½ï¼Œè¯·æ³¨æ˜å‡ºå¤„â€æœ¬æ–‡é¦–å‘äº<a href="https://yizibi.github.io/">ä¸€ä¹‹ç¬”</a>â€;</p>

<p>å¼•è¨€</p>

<blockquote>
  <p>éšç€å…¬å¸ä¸šåŠ¡çš„éœ€è¦ï¼ŒåŸæ¥çš„æ¨é€ï¼Œä¸èƒ½æ»¡è¶³ç°æœ‰çš„è¦æ±‚ï¼Œæ¯”å¦‚ï¼Œæœ‰çš„å…¬å¸éœ€è¦å±€åŸŸç½‘éƒ¨ç½²å¹³å°æœåŠ¡ï¼Œä¸èƒ½è®¿é—®å¤–ç½‘ï¼Œæ„å‘³ç€ï¼Œé€šè¿‡è‡ªå¸¦çš„ APNSè¿œç¨‹æ¨é€æœåŠ¡ï¼ŒåŸºæœ¬ä¸Šå°±æŒ‚æ‰äº†;å†æ¯”å¦‚ï¼Œå…¬å¸çš„æŸä¸€ä¸ªä¸šåŠ¡ï¼Œéœ€è¦å®æ—¶åˆ·æ–°æ•°æ®ï¼Œå¦‚è‚¡ç¥¨ä»·æ ¼ï¼ŒæŠ¥è­¦å®æ—¶ç›‘æµ‹æ•°æ®ç­‰è¿™ç§åœºæ™¯ã€‚è¿™æ—¶å€™ï¼Œå°±éœ€è¦å¦è¾Ÿè¹Šå¾„ï¼›å½“ç„¶ï¼Œæˆ‘ä»¬æœ‰å¾ˆå¤šç§é€‰æ‹©ï¼Œæ¯”å¦‚ï¼ŒRabbitMQ-å®ç°äº†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®çš„å¼€æºæ¶ˆæ¯ä»£ç†è½¯ä»¶ï¼Œä¸ºå•¥è¦ç”¨è¿™ä¸ªå‘¢ï¼Œå› ä¸ºAndroidå·²ç»ç”¨è¿™ä¸ªåšå¥½äº†ï¼Œæ‰€ä»¥ï¼ŒiOS ä¹Ÿæ²¡æœ‰å…¶ä»–é€‰æ‹©äº†;</p>
</blockquote>

<p>åœ¨é›†æˆå®¢æˆ·ç«¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰ä¸€äº›æ¦‚å¿µéœ€è¦çŸ¥é“ï¼Œå¦‚æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”Ÿäº§è€…ï¼Œæ¶ˆè´¹è€…ï¼Œäº¤æ¢å™¨ï¼Œé˜Ÿåˆ—,é€šé“ç­‰ï¼›</p>

<h2 id="ä¸€rabbitmq-çš„ç›¸å…³æ¦‚å¿µ">ä¸€.RabbitMQ çš„ç›¸å…³æ¦‚å¿µ</h2>

<h3 id="11-ç®€ä»‹">1.1 ç®€ä»‹</h3>

<p>RabbitMQ æœ¬è´¨ä¸Šæ˜¯ MBï¼ˆMessage Broker) æ¶ˆæ¯ä»£ç†ï¼Œå¯ä»¥è¿™ä¹ˆè®¤ä¸ºï¼Œ<a href="https://www.rabbitmq.com/tutorials/tutorial-one-objectivec.html">RabbitMQ</a>å°±åƒä¸€ä¸ª â€œé‚®å±€â€ï¼Œè´Ÿè´£æ”¶å‘å­˜å‚¨é‚®åŒ…ï¼ˆæ¶ˆæ¯ï¼‰ï¼Œå”¯ä¸€ä¸é‚®å±€ä¸åŒçš„æ˜¯ï¼Œå®ƒä¸ä¼šå¤„ç†æ¶ˆæ¯å†…å®¹</p>

<p>==AMQP==ï¼Œå³Advanced Message Queuing Protocolï¼Œé«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œæ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼›ç±»ä¼¼Http,https,STMPè¿™ç§ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ï¼Œä»–æ˜¯ä¸€ä¸ªåè®®ï¼Œå®é™…å¼€å‘ä¸­ä¼šé‡åˆ°ï¼Œåº•å±‚å®ç°æˆ‘ä»¬ä¸ç”¨ç®¡ï¼›</p>

<h3 id="12-mqçš„ç‰¹å¾">1.2 MQçš„ç‰¹å¾</h3>

<p>RabbitMQ æ˜¯ä¸€ä¸ªç”± Erlang è¯­è¨€å¼€å‘çš„ AMQP çš„å¼€æºå®ç°ã€‚</p>

<p>æ”¯æŒå¤šç§å®¢æˆ·ç«¯ï¼Œå¦‚ï¼š==Pythonã€Rubyã€.NETã€Javaã€JMSã€Cã€PHPã€ActionScriptã€XMPPã€STOMPï¼ŒObject-C, Swift==ç­‰ï¼Œæ”¯æŒAJAXã€‚ç”¨äºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å­˜å‚¨è½¬å‘æ¶ˆæ¯ï¼Œåœ¨æ˜“ç”¨æ€§ã€æ‰©å±•æ€§ã€é«˜å¯ç”¨æ€§ç­‰æ–¹é¢è¡¨ç°ä¸ä¿—ã€‚</p>

<ul>
  <li>å¯é æ€§ï¼ˆReliabilityï¼‰</li>
</ul>

<p>RabbitMQ ä½¿ç”¨ä¸€äº›æœºåˆ¶æ¥ä¿è¯å¯é æ€§ï¼Œå¦‚æŒä¹…åŒ–ã€ä¼ è¾“ç¡®è®¤ã€å‘å¸ƒç¡®è®¤ã€‚</p>

<ul>
  <li>çµæ´»çš„è·¯ç”±ï¼ˆFlexible Routingï¼‰</li>
</ul>

<p>åœ¨æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ—ä¹‹å‰ï¼Œé€šè¿‡ Exchange æ¥è·¯ç”±æ¶ˆæ¯çš„ã€‚å¯¹äºå…¸å‹çš„è·¯ç”±åŠŸèƒ½ï¼ŒRabbitMQ å·²ç»æä¾›äº†ä¸€äº›å†…ç½®çš„ Exchange æ¥å®ç°ã€‚é’ˆå¯¹æ›´å¤æ‚çš„è·¯ç”±åŠŸèƒ½ï¼Œå¯ä»¥å°†å¤šä¸ª Exchange ç»‘å®šåœ¨ä¸€èµ·ï¼Œä¹Ÿé€šè¿‡æ’ä»¶æœºåˆ¶å®ç°è‡ªå·±çš„ Exchange ã€‚</p>

<ul>
  <li>æ¶ˆæ¯é›†ç¾¤ï¼ˆClusteringï¼‰</li>
</ul>

<p>å¤šä¸ª RabbitMQ æœåŠ¡å™¨å¯ä»¥ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œå½¢æˆä¸€ä¸ªé€»è¾‘ Broker ã€‚</p>

<ul>
  <li>é«˜å¯ç”¨ï¼ˆHighly Available Queuesï¼‰</li>
</ul>

<p>é˜Ÿåˆ—å¯ä»¥åœ¨é›†ç¾¤ä¸­çš„æœºå™¨ä¸Šè¿›è¡Œé•œåƒï¼Œä½¿å¾—åœ¨éƒ¨åˆ†èŠ‚ç‚¹å‡ºé—®é¢˜çš„æƒ…å†µä¸‹é˜Ÿåˆ—ä»ç„¶å¯ç”¨ã€‚</p>

<ul>
  <li>å¤šç§åè®®ï¼ˆMulti-protocolï¼‰</li>
</ul>

<p>RabbitMQ æ”¯æŒå¤šç§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œæ¯”å¦‚ STOMPã€MQTT ç­‰ç­‰ã€‚</p>

<ul>
  <li>å¤šè¯­è¨€å®¢æˆ·ç«¯ï¼ˆMany Clientsï¼‰</li>
</ul>

<p>RabbitMQ å‡ ä¹æ”¯æŒæ‰€æœ‰å¸¸ç”¨è¯­è¨€ï¼Œæ¯”å¦‚ Javaã€.NETã€Ruby, Object-Cç­‰ç­‰ã€‚</p>

<ul>
  <li>ç®¡ç†ç•Œé¢ï¼ˆManagement UIï¼‰</li>
</ul>

<p>RabbitMQ æä¾›äº†ä¸€ä¸ªæ˜“ç”¨çš„ç”¨æˆ·ç•Œé¢ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥ç›‘æ§å’Œç®¡ç†æ¶ˆæ¯ Broker çš„è®¸å¤šæ–¹é¢ã€‚</p>

<ul>
  <li>è·Ÿè¸ªæœºåˆ¶ï¼ˆTracingï¼‰</li>
</ul>

<p>å¦‚æœæ¶ˆæ¯å¼‚å¸¸ï¼ŒRabbitMQ æä¾›äº†æ¶ˆæ¯è·Ÿè¸ªæœºåˆ¶ï¼Œä½¿ç”¨è€…å¯ä»¥æ‰¾å‡ºå‘ç”Ÿäº†ä»€ä¹ˆã€‚</p>

<ul>
  <li>æ’ä»¶æœºåˆ¶ï¼ˆPlugin Systemï¼‰</li>
</ul>

<p>RabbitMQ æä¾›äº†è®¸å¤šæ’ä»¶ï¼Œæ¥ä»å¤šæ–¹é¢è¿›è¡Œæ‰©å±•ï¼Œä¹Ÿå¯ä»¥ç¼–å†™è‡ªå·±çš„æ’ä»¶ã€‚</p>

<h3 id="13-rabbitmqçš„æ¦‚å¿µæ¨¡å‹">1.3 RabbitMQçš„æ¦‚å¿µæ¨¡å‹</h3>

<p>æ‰€æœ‰ MQ äº§å“ä»æ¨¡å‹æŠ½è±¡ä¸Šæ¥è¯´éƒ½æ˜¯ä¸€æ ·çš„è¿‡ç¨‹ï¼š
æ¶ˆè´¹è€…ï¼ˆconsumerï¼‰è®¢é˜…æŸä¸ªé˜Ÿåˆ—ã€‚ç”Ÿäº§è€…ï¼ˆproducerï¼‰åˆ›å»ºæ¶ˆæ¯ï¼Œç„¶åå‘å¸ƒåˆ°é˜Ÿåˆ—ï¼ˆqueueï¼‰ä¸­ï¼Œæœ€åå°†æ¶ˆæ¯å‘é€åˆ°ç›‘å¬çš„æ¶ˆè´¹è€…ã€‚</p>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/MQ-sendMessage.png" alt="æ¶ˆæ¯æ¨¡å‹" /></p>

<ul>
  <li>AMQPçš„å†…éƒ¨ç»“æ„</li>
</ul>

<p>ä¸Šé¢ä»‹ç»RabbitMQæ˜¯AMQPçš„å®ç°ï¼Œæ‰€ä»¥å…¶å†…éƒ¨ä¹Ÿæ˜¯AMQPçš„æ¦‚å¿µ</p>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/MQ/AMQP-image.png" alt="RabbbitMQçš„å†…éƒ¨ç»“æ„" /></p>

<ul>
  <li>P(Producer) ç”Ÿäº§è€…ï¼Œæœ‰çš„ä¹Ÿç§°ä¹‹ä¸º Publisher,æ¶ˆæ¯çš„å‘å¸ƒè€…</li>
</ul>

<p>å‘é€æ¶ˆæ¯çš„ç¨‹åºæˆ–è€…ä»£ç å°±æ˜¯ç”Ÿäº§è€…ï¼Œä¸€èˆ¬æ˜¯ æœåŠ¡ç«¯</p>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/MQ-producer.png" alt="ç”Ÿäº§è€…" /></p>

<ul>
  <li>Exchange(äº¤æ¢å™¨)</li>
</ul>

<p>äº¤æ¢å™¨ï¼Œç”¨æ¥æ¥æ”¶ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯å¹¶å°†è¿™äº›æ¶ˆæ¯è·¯ç”±ç»™æœåŠ¡å™¨ä¸­çš„é˜Ÿåˆ—.ç”Ÿäº§è€…æŠŠæ¶ˆæ¯å‘å¸ƒåˆ° Exchange ä¸Šï¼Œæ¶ˆæ¯æœ€ç»ˆåˆ°è¾¾é˜Ÿåˆ—å¹¶è¢«æ¶ˆè´¹è€…æ¥æ”¶ï¼Œè€Œ Binding å†³å®šäº¤æ¢å™¨çš„æ¶ˆæ¯åº”è¯¥å‘é€åˆ°é‚£ä¸ªé˜Ÿåˆ—ã€‚</p>

<ul>
  <li>routing key</li>
</ul>

<p>ç”Ÿäº§è€…åœ¨å°†æ¶ˆæ¯å‘é€ç»™Exchangeçš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šæŒ‡å®šä¸€ä¸ªrouting keyï¼Œæ¥æŒ‡å®šè¿™ä¸ªæ¶ˆæ¯çš„è·¯ç”±è§„åˆ™ï¼Œè€Œè¿™ä¸ªrouting keyéœ€è¦ä¸Exchange TypeåŠbinding keyè”åˆä½¿ç”¨æ‰èƒ½æœ€ç»ˆç”Ÿæ•ˆã€‚
åœ¨Exchange Typeä¸binding keyå›ºå®šçš„æƒ…å†µä¸‹ï¼ˆåœ¨æ­£å¸¸ä½¿ç”¨æ—¶ä¸€èˆ¬è¿™äº›å†…å®¹éƒ½æ˜¯å›ºå®šé…ç½®å¥½çš„ï¼‰ï¼Œæˆ‘ä»¬çš„ç”Ÿäº§è€…å°±å¯ä»¥åœ¨å‘é€æ¶ˆæ¯ç»™Exchangeæ—¶ï¼Œé€šè¿‡æŒ‡å®šrouting keyæ¥å†³å®šæ¶ˆæ¯æµå‘å“ªé‡Œã€‚
RabbitMQä¸ºrouting keyè®¾å®šçš„é•¿åº¦é™åˆ¶ä¸º255 bytesã€‚
æ­¤å¤–ï¼Œè¿™ä¸ª Key å€¼ï¼Œä¸€èˆ¬æ˜¯æœåŠ¡ç«¯è·Ÿå®¢æˆ·ç«¯çº¦å®šå¥½çš„ï¼Œå¯ä»¥æ˜¯ç»„ç»‡IDï¼Œä¹Ÿå¯ä»¥ç”¨ID</p>

<ul>
  <li>Binding(ç»‘å®š)</li>
</ul>

<p>ç»‘å®šï¼Œç”¨äºæ¶ˆæ¯é˜Ÿåˆ—å’Œäº¤æ¢å™¨ä¹‹é—´çš„å…³è”ã€‚ä¸€ä¸ªç»‘å®šå°±æ˜¯åŸºäºè·¯ç”±é”®å°†äº¤æ¢å™¨å’Œæ¶ˆæ¯é˜Ÿåˆ—è¿æ¥èµ·æ¥çš„è·¯ç”±è§„åˆ™ï¼Œæ‰€ä»¥å¯ä»¥å°†äº¤æ¢å™¨ç†è§£æˆä¸€ä¸ªç”±ç»‘å®šæ„æˆçš„è·¯ç”±è¡¨ã€‚</p>

<ul>
  <li>Queue(é˜Ÿåˆ—)</li>
</ul>

<p>æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜æ¶ˆæ¯ç›´åˆ°å‘é€ç»™æ¶ˆè´¹è€…ã€‚å®ƒæ˜¯æ¶ˆæ¯çš„å®¹å™¨ï¼Œä¹Ÿæ˜¯æ¶ˆæ¯çš„ç»ˆç‚¹ã€‚ä¸€ä¸ªæ¶ˆæ¯å¯æŠ•å…¥ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—ã€‚æ¶ˆæ¯ä¸€ç›´åœ¨é˜Ÿåˆ—é‡Œé¢ï¼Œç­‰å¾…æ¶ˆè´¹è€…è¿æ¥åˆ°è¿™ä¸ªé˜Ÿåˆ—å°†å…¶å–èµ°ã€‚</p>

<ul>
  <li>Connection(è¿æ¥)</li>
</ul>

<p>ç½‘ç»œè¿æ¥ï¼Œæ¯”å¦‚ä¸€ä¸ªTCPè¿æ¥ï¼ŒRabbitMQçš„OC CLientå°±æ˜¯å°è£…äº† å¼€æºçš„TCPå®ç°<a href="https://github.com/robbiehanson/CocoaAsyncSocket">CocoaAsyncSocket</a></p>

<ul>
  <li>Channel(ä¿¡é“)</li>
</ul>

<p>ä¿¡é“ï¼Œå¤šè·¯å¤ç”¨è¿æ¥ä¸­çš„ä¸€æ¡ç‹¬ç«‹çš„åŒå‘æ•°æ®æµé€šé“ã€‚ä¿¡é“æ˜¯å»ºç«‹åœ¨çœŸå®çš„TCPè¿æ¥å†…åœ°è™šæ‹Ÿè¿æ¥ï¼ŒAMQP å‘½ä»¤éƒ½æ˜¯é€šè¿‡ä¿¡é“å‘å‡ºå»çš„ï¼Œä¸ç®¡æ˜¯å‘å¸ƒæ¶ˆæ¯ã€è®¢é˜…é˜Ÿåˆ—è¿˜æ˜¯æ¥æ”¶æ¶ˆæ¯ï¼Œè¿™äº›åŠ¨ä½œéƒ½æ˜¯é€šè¿‡ä¿¡é“å®Œæˆã€‚å› ä¸ºå¯¹äºæ“ä½œç³»ç»Ÿæ¥è¯´å»ºç«‹å’Œé”€æ¯ TCP éƒ½æ˜¯éå¸¸æ˜‚è´µçš„å¼€é”€ï¼Œæ‰€ä»¥å¼•å…¥äº†ä¿¡é“çš„æ¦‚å¿µï¼Œä»¥å¤ç”¨ä¸€æ¡ TCP è¿æ¥ã€‚</p>

<ul>
  <li>
    <p>Virtual Host(è™šæ‹Ÿä¸»æœº)
è™šæ‹Ÿä¸»æœºï¼Œè¡¨ç¤ºä¸€æ‰¹äº¤æ¢å™¨ã€æ¶ˆæ¯é˜Ÿåˆ—å’Œç›¸å…³å¯¹è±¡ã€‚è™šæ‹Ÿä¸»æœºæ˜¯å…±äº«ç›¸åŒçš„èº«ä»½è®¤è¯å’ŒåŠ å¯†ç¯å¢ƒçš„ç‹¬ç«‹æœåŠ¡å™¨åŸŸã€‚æ¯ä¸ª vhost æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª mini ç‰ˆçš„ RabbitMQ æœåŠ¡å™¨ï¼Œæ‹¥æœ‰è‡ªå·±çš„é˜Ÿåˆ—ã€äº¤æ¢å™¨ã€ç»‘å®šå’Œæƒé™æœºåˆ¶ã€‚vhost æ˜¯ AMQP æ¦‚å¿µçš„åŸºç¡€ï¼Œå¿…é¡»åœ¨è¿æ¥æ—¶æŒ‡å®šï¼ŒRabbitMQ é»˜è®¤çš„ vhost æ˜¯ /</p>
  </li>
  <li>
    <p>C(Consumer) æ¶ˆè´¹è€…</p>
  </li>
</ul>

<p>è®¢é˜…æŸä¸ªé˜Ÿåˆ—ï¼Œæ¶ˆæ¯çš„æ¥å—è€…</p>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/MQ-consumer.png" alt="æ¶ˆè´¹è€…" /></p>

<h3 id="14-rabbitmq-ä¸­çš„æ¶ˆæ¯è·¯ç”±">1.4 RabbitMQ ä¸­çš„æ¶ˆæ¯è·¯ç”±</h3>
<p>ç”Ÿäº§è€…æŠŠæ¶ˆæ¯å‘å¸ƒåˆ° Exchange ä¸Šï¼Œæ¶ˆæ¯æœ€ç»ˆåˆ°è¾¾é˜Ÿåˆ—å¹¶è¢«æ¶ˆè´¹è€…æ¥æ”¶ï¼Œè€Œ Binding å†³å®šäº¤æ¢å™¨çš„æ¶ˆæ¯åº”è¯¥å‘é€åˆ°é‚£ä¸ªé˜Ÿåˆ—ã€‚</p>

<p>åœ¨ç»‘å®šï¼ˆBindingï¼‰Exchangeä¸Queueçš„åŒæ—¶ï¼Œä¸€èˆ¬ä¼šæŒ‡å®šä¸€ä¸ªbinding keyï¼›ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€ç»™Exchangeæ—¶ï¼Œä¸€èˆ¬ä¼šæŒ‡å®šä¸€ä¸ªrouting keyï¼›å½“binding keyä¸routing keyç›¸åŒ¹é…æ—¶ï¼Œæ¶ˆæ¯å°†ä¼šè¢«è·¯ç”±åˆ°å¯¹åº”çš„Queueä¸­ã€‚
åœ¨ç»‘å®šå¤šä¸ªQueueåˆ°åŒä¸€ä¸ªExchangeçš„æ—¶å€™ï¼Œè¿™äº›Bindingå…è®¸ä½¿ç”¨ç›¸åŒçš„binding keyã€‚
binding key å¹¶ä¸æ˜¯åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½ç”Ÿæ•ˆï¼Œå®ƒä¾èµ–äºExchange Typeï¼Œæ¯”å¦‚fanoutç±»å‹çš„Exchangeå°±ä¼šæ— è§†binding keyï¼Œè€Œæ˜¯å°†æ¶ˆæ¯è·¯ç”±åˆ°æ‰€æœ‰ç»‘å®šåˆ°è¯¥Exchangeçš„Queueã€‚</p>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/MQ/MQroute.png" alt="AMOPçš„æ¶ˆæ¯è·¯ç”±" /></p>

<h3 id="15-rabbitmq-çš„exchange-types">1.5 RabbitMQ çš„Exchange Types</h3>

<p>RabbitMQå¸¸ç”¨çš„Exchange Typeæœ‰==fanout==ã€==direct==ã€==topic==ã€==headers==è¿™å››ç§ï¼ˆAMQPè§„èŒƒé‡Œè¿˜æåˆ°ä¸¤ç§Exchange Typeï¼Œåˆ†åˆ«ä¸ºsystemä¸è‡ªå®šä¹‰ï¼Œè¿™é‡Œä¸äºˆä»¥æè¿°ï¼‰ï¼Œheaders åŒ¹é… AMQP æ¶ˆæ¯çš„ header è€Œä¸æ˜¯è·¯ç”±é”®ï¼Œæ­¤å¤– headers äº¤æ¢å™¨å’Œ direct äº¤æ¢å™¨å®Œå…¨ä¸€è‡´ï¼Œä½†æ€§èƒ½å·®å¾ˆå¤šï¼Œç›®å‰å‡ ä¹ç”¨ä¸åˆ°äº†ï¼Œæ‰€ä»¥ç›´æ¥çœ‹å¦å¤–ä¸‰ç§ç±»å‹ï¼š</p>

<ul>
  <li>direct</li>
</ul>

<p>directç±»å‹çš„Exchangeè·¯ç”±è§„åˆ™ä¹Ÿå¾ˆç®€å•ï¼Œå®ƒä¼šæŠŠæ¶ˆæ¯è·¯ç”±åˆ°é‚£äº›binding keyä¸routing keyå®Œå…¨åŒ¹é…çš„Queueä¸­ã€‚</p>

<p>ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>/** åˆ›å»ºä¿¡é“ */
id&lt;RMQChannel&gt; ch = [_conn createChannel];
/** åˆ›å»ºäº¤æ¢å™¨ï¼Œdirectæ–¹æ³•ï¼Œè¿™ä¸ªéœ€è¦è·Ÿåå°ä¿æŒä¸€è‡´ï¼ŒåŒ…æ‹¬äº¤æ¢å™¨çš„åç§°ï¼Œä¹Ÿè¦è·Ÿåå°çº¦å®šå¥½ï¼Œè¿˜æœ‰é…ç½®é€‰é¡¹ï¼Œæ˜¯å¦æŒä¹…åŒ–ç­‰ */
RMQExchange *x = [ch  direct:@"Mobile_Alarm" options:(RMQExchangeDeclareNoOptions)];
/** åˆ›å»ºé˜Ÿåˆ—ï¼Œå¦‚æœä¸æŒ‡å®šé˜Ÿåˆ—åç§°ï¼ŒMQä¼šé»˜è®¤è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œå‰ç¼€ä»¥ `rmq-objc-client.gen-` å¼€å¤´ */
RMQQueue *q = [ch queue:@"" options:RMQQueueDeclareExclusive | RMQQueueDeclareAutoDelete];
/** é˜Ÿåˆ—ç»‘å®šäº¤æ¢å™¨ï¼Œå¹¶æŒ‡å®š rountKeyï¼Œéœ€è¦è·Ÿåå°æŒ‡å®šç›¸åŒçš„è§„åˆ™ï¼Œå¯ä»¥æ˜¯ç”¨æˆ·IDç­‰ */
[q bind:x routingKey:@"5"];

</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/MQ-Direct.png" alt="Exchange Directç±»å‹" /></p>

<ul>
  <li>fanout
è¿™ç§ç±»å‹çš„Exchange,å°±æ˜¯ç¾¤å‘ï¼Œæ­¤exchangeçš„è·¯ç”±è§„åˆ™å¾ˆç®€å•ç›´æ¥å°†æ¶ˆæ¯è·¯ç”±åˆ°æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ—ä¸­ï¼Œæ— é¡»å¯¹æ¶ˆæ¯çš„routingkeyè¿›è¡ŒåŒ¹é…æ“ä½œã€‚</li>
</ul>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/MQ%20fanout.png" alt="Exchange fanoutç±»å‹" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre>/**  éœ€è¦æ³¨æ„ï¼š&lt;RMQConnectionDelegate&gt; å¦‚æœåˆ›å»ºè¿æ¥ï¼ŒæŒ‡å®šä»£ç†æ˜¯ å½“å‰class,é‚£ä¹ˆå½“å‰classéœ€è¦éµå®ˆè¿æ¥çš„ä»£ç†åè®®ï¼Œå¹¶å®ç°ç›¸å…³ä»£ç†æ–¹æ³•*/

/** åˆ›å»ºè¿æ¥ */
RMQConnection *conn = [[RMQConnection alloc] initWithUri:url5 delegate:self];
[conn start];
/** åˆ›å»ºä¿¡é“ */
id&lt;RMQChannel&gt; ch = [conn createChannel];
/** åˆ›å»ºäº¤æ¢å™¨ */
RMQExchange *x = [ch fanout:@"Alarm"];
RMQQueue *q = [ch queue:@"" options:RMQQueueDeclareExclusive];
/** ç»‘å®šäº¤æ¢å™¨ */
[q bind:x];
/** è®¢é˜…æ¶ˆæ¯ */
[q subscribe:^(RMQMessage * _Nonnull message) {
NSLog(@"Received %@", [[NSString alloc] initWithData:message.body encoding:NSUTF8StringEncoding]);
}];

///socket è¿æ¥å¤±è´¥å›è°ƒï¼Œè¶…æ—¶æˆ–è€…åœ°å€æœ‰è¯¯
- (void)connection:(RMQConnection *)connection failedToConnectWithError:(NSError *)error;
/// æ²¡æœ‰è¿æ¥æˆåŠŸå›è°ƒ
- (void)connection:(RMQConnection *)connection disconnectedWithError:(NSError *)error;
/// è‡ªåŠ¨æ¢å¤è¿æ¥è°ƒç”¨
- (void)willStartRecoveryWithConnection:(RMQConnection *)connection;
/// æ­£åœ¨å¼€å§‹æ¢å¤è¿æ¥
- (void)startingRecoveryWithConnection:(RMQConnection *)connection;
/// å·²ç»æ¢å¤è¿æ¥çš„æ—¶å€™ï¼Œè°ƒç”¨
- (void)recoveredConnection:(RMQConnection *)connection;
/// è¿æ¥è¿‡ç¨‹ä¸­ï¼Œä¿¡é“å¼‚å¸¸è°ƒç”¨
- (void)channel:(id&lt;RMQChannel&gt;)channel error:(NSError *)error;
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>Topic</li>
</ul>

<p>å‰é¢è®²åˆ°directç±»å‹çš„Exchangeè·¯ç”±è§„åˆ™æ˜¯å®Œå…¨åŒ¹é…binding keyä¸routing keyï¼Œä½†è¿™ç§ä¸¥æ ¼çš„åŒ¹é…æ–¹å¼åœ¨å¾ˆå¤šæƒ…å†µä¸‹ä¸èƒ½æ»¡è¶³å®é™…ä¸šåŠ¡éœ€æ±‚ã€‚topicç±»å‹çš„Exchangeåœ¨åŒ¹é…è§„åˆ™ä¸Šè¿›è¡Œäº†æ‰©å±•ï¼Œå®ƒä¸directç±»å‹çš„Exchageç›¸ä¼¼ï¼Œä¹Ÿæ˜¯å°†æ¶ˆæ¯è·¯ç”±åˆ°binding keyä¸routing keyç›¸åŒ¹é…çš„Queueä¸­ï¼Œä½†è¿™é‡Œçš„åŒ¹é…è§„åˆ™æœ‰äº›ä¸åŒï¼Œå®ƒçº¦å®šï¼š</p>

<blockquote>
  <p>routing keyä¸ºä¸€ä¸ªå¥ç‚¹å·â€œ. â€åˆ†éš”çš„å­—ç¬¦ä¸²ï¼ˆæˆ‘ä»¬å°†è¢«å¥ç‚¹å·â€œ. â€åˆ†éš”å¼€çš„æ¯ä¸€æ®µç‹¬ç«‹çš„å­—ç¬¦ä¸²ç§°ä¸ºä¸€ä¸ªå•è¯ï¼‰ï¼Œå¦‚â€œdevice.userIdâ€ã€â€œalarm.typeâ€ï¼Œ
binding keyä¸routing keyä¸€æ ·ä¹Ÿæ˜¯å¥ç‚¹å·â€œ. â€åˆ†éš”çš„å­—ç¬¦ä¸²
binding keyä¸­å¯ä»¥å­˜åœ¨ä¸¤ç§ç‰¹æ®Šå­—ç¬¦â€œ<em>â€ä¸â€œ#â€ï¼Œç”¨äºåšæ¨¡ç³ŠåŒ¹é…ï¼Œå…¶ä¸­â€œ</em>â€ç”¨äºåŒ¹é…ä¸€ä¸ªå•è¯ï¼Œâ€œ#â€ç”¨äºåŒ¹é…å¤šä¸ªå•è¯ï¼ˆå¯ä»¥æ˜¯é›¶ä¸ªï¼‰</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>RMQConnection * connection = [[RMQConnection alloc] initWithUri:url delegate:[RMQConnectionDelegateLogger new]];
[connection start];
id&lt;RMQChannel&gt;channel = [connection createChannel];
RMQExchange * exchange = [channel topic:@"topic_logs" options:RMQExchangeDeclarePassive];
[exchange publish:finalData routingKey:[NSString stringWithFormat:@"device.%@",didStr]];
[connection close];

</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/MQ%20topic%20Type.png" alt="Topic ç±»å‹" /></p>

<p>ä»¥ä¸Šå›¾ä¸­çš„é…ç½®ä¸ºä¾‹ï¼ŒroutingKey=â€dev.alarm.deviceâ€çš„æ¶ˆæ¯ä¼šåŒæ—¶è·¯ç”±åˆ°QAä¸QBï¼ŒroutingKey=â€dev.alarm.typeâ€çš„æ¶ˆæ¯ä¼šè·¯ç”±åˆ°QAï¼ŒroutingKey=â€lazy.brown.foxâ€çš„æ¶ˆæ¯ä¼šè·¯ç”±åˆ°Q2ï¼ŒroutingKey=â€water.type.IDâ€çš„æ¶ˆæ¯ä¼šè·¯ç”±åˆ°QBï¼›routingKey=â€device.user.waterâ€ã€routingKey=â€alarmtypeâ€çš„æ¶ˆæ¯å°†ä¼šè¢«ä¸¢å¼ƒï¼Œå› ä¸ºå®ƒä»¬æ²¡æœ‰åŒ¹é…ä»»ä½•bindingKeyã€‚</p>

<h2 id="äºŒrabbitmq-çš„é›†æˆ">äºŒ.RabbitMQ çš„é›†æˆ</h2>

<h3 id="21-å®¢æˆ·ç«¯é›†æˆ">2.1 å®¢æˆ·ç«¯é›†æˆ</h3>

<p><a href="https://github.com/rabbitmq/rabbitmq-objc-client">RabbitMQå®˜æ–¹Gitä»“åº“</a></p>

<ul>
  <li>æˆ‘ç”¨çš„æ˜¯CocoaPodsé›†æˆ,åœ¨ podfile ä¸­æ·»åŠ ï¼š</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>pod 'RMQClient'

</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ³¨æ„ï¼š</p>

<p>RabbitMQ pod å†…éƒ¨æœ‰ <a href="https://github.com/robbiehanson/CocoaAsyncSocket">CocoaAsyncSocket</a>,å¦‚æœé¡¹ç›®ä¸­ï¼Œå·²ç»é›†æˆäº†ï¼Œéœ€è¦åˆ é™¤å¤šä½™çš„</p>

<h3 id="22-æºä»£ç æ–‡ä»¶">2.2 æºä»£ç æ–‡ä»¶</h3>

<p>è€ƒè™‘åˆ°å®¢æˆ·ç«¯æ¶æ„çš„ç‰¹æ®Šæ€§ï¼Œéœ€è¦å°†MQæ¶ˆæ¯è®¢é˜…å°è£…æˆä¸€ä¸ªå·¥å…·,å¹¶é…ç½®ä¸º å•ä¾‹ æ¨¡å¼ã€‚</p>

<blockquote>
  <p>å¯¼å…¥å¤´æ–‡ä»¶  #import <RMQClient.h></RMQClient.h></p>
</blockquote>

<p>LXCustomRabbitMQManger.h</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>//å¼€å§‹è®¢é˜…æ¶ˆæ¯
- (void)startScribeMessage;
//å…³é—­è¿æ¥
- (void)closeConnection;
</pre></td></tr></tbody></table></code></pre></div></div>
<p>LXCustomRabbitMQManger.m</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
</pre></td><td class="rouge-code"><pre>@interface LXCustomRabbitMQManger()&lt;RMQConnectionDelegate&gt;

@property (nonatomic,strong) RMQConnection *conn;
@property (nonatomic,strong) LXCustomAlarmModel *alarmModel;

@end


- (void)startScribeMessage {
[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(activeNotification:) name:UIApplicationDidBecomeActiveNotification object:nil];
[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(backgroundNotification:) name:UIApplicationDidEnterBackgroundNotification object:nil];
}

- (void)closeConnection {
if (_conn) {
[self.conn close];
self.conn = nil;
}
}

//åˆ›å»ºæœ¬åœ°æ¨é€
- (void)registerNotification:(NSInteger )alerTime {
kweakSelf;
kStrongSelf;
// ä½¿ç”¨ UNUserNotificationCenter æ¥ç®¡ç†é€šçŸ¥
if (@available(iOS 10.0, *)) {
// ä½¿ç”¨ UNUserNotificationCenter æ¥ç®¡ç†é€šçŸ¥
UNUserNotificationCenter* center = [UNUserNotificationCenter currentNotificationCenter];
//éœ€åˆ›å»ºä¸€ä¸ªåŒ…å«å¾…é€šçŸ¥å†…å®¹çš„ UNMutableNotificationContent å¯¹è±¡ï¼Œæ³¨æ„ä¸æ˜¯ UNNotificationContent ,æ­¤å¯¹è±¡ä¸ºä¸å¯å˜å¯¹è±¡ã€‚
UNMutableNotificationContent* content = [[UNMutableNotificationContent alloc] init];
content.title = [NSString localizedUserNotificationStringForKey:self.alarmModel.alarm_type arguments:nil];
content.body = [NSString localizedUserNotificationStringForKey:self.alarmModel.geography
arguments:nil];
content.sound = [UNNotificationSound defaultSound];

// åœ¨ alertTime åæ¨é€æœ¬åœ°æ¨é€
UNTimeIntervalNotificationTrigger* trigger = [UNTimeIntervalNotificationTrigger
triggerWithTimeInterval:alerTime repeats:NO];
UNNotificationRequest* request = [UNNotificationRequest requestWithIdentifier:@"FiveSecond"
content:content trigger:trigger];
//æ·»åŠ æ¨é€æˆåŠŸåçš„å¤„ç†ï¼
[center addNotificationRequest:request withCompletionHandler:^(NSError * _Nullable error) {
/*
DQAlertView *reservationAlert = [[DQAlertView alloc] initWithTitle:self.alarmModel.alarm_type
message:self.alarmModel.geography
delegate:self cancelButtonTitle:@"å–æ¶ˆ"
otherButtonTitles:@"ç¡®å®š"];

reservationAlert.shouldDimBackgroundWhenShowInView = YES;
reservationAlert.shouldDismissOnOutsideTapped = YES;
[reservationAlert show];
[reservationAlert actionWithBlocksCancelButtonHandler:^{


} otherButtonHandler:^{
//è·³è½¬
LXDeviceAlarmModel *alarmIDModel = [[LXDeviceAlarmModel alloc] init];
alarmIDModel.ID = strongSelf.alarmModel.ID;
LXDeviceDetailController *deviceDetailVC = [[LXDeviceDetailController alloc] init];
deviceDetailVC.deviceDealType = KearlyNoDealType;
deviceDetailVC.deviceAlarm = alarmIDModel;
[[self getCurrentVC].navigationController pushViewController:deviceDetailVC animated:YES];

}];
*/
UIAlertController *alert = [UIAlertController alertControllerWithTitle:self.alarmModel.alarm_type message:self.alarmModel.geography preferredStyle:UIAlertControllerStyleAlert];
UIAlertAction *cancelAction = [UIAlertAction actionWithTitle:@"å–æ¶ˆ" style:UIAlertActionStyleCancel handler:nil];
UIAlertAction *confirmAction = [UIAlertAction actionWithTitle:@"ç¡®å®š" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
LXDeviceAlarmModel *alarmIDModel = [[LXDeviceAlarmModel alloc] init];
alarmIDModel.ID = strongSelf.alarmModel.ID;
LXDeviceDetailController *deviceDetailVC = [[LXDeviceDetailController alloc] init];
deviceDetailVC.deviceDealType = KearlyNoDealType;
deviceDetailVC.deviceAlarm = alarmIDModel;
[[self getCurrentVC].navigationController pushViewController:deviceDetailVC animated:YES];
}];
[alert addAction:cancelAction];
[alert addAction:confirmAction];
[[UIApplication sharedApplication].keyWindow.rootViewController presentViewController:alert animated:YES completion:nil];

}];
}
else {
UILocalNotification *notification = [[UILocalNotification alloc] init];
// è®¾ç½®è§¦å‘é€šçŸ¥çš„æ—¶é—´
NSDate *fireDate = [NSDate dateWithTimeIntervalSinceNow:1];
NSLog(@"fireDate=%@",fireDate);

notification.fireDate = fireDate;
// æ—¶åŒº
notification.timeZone = [NSTimeZone defaultTimeZone];
// è®¾ç½®é‡å¤çš„é—´éš”
notification.repeatInterval = kCFCalendarUnitSecond;

// é€šçŸ¥å†…å®¹
notification.alertBody =  self.alarmModel.alarm_type;
notification.applicationIconBadgeNumber = 1;
// é€šçŸ¥è¢«è§¦å‘æ—¶æ’­æ”¾çš„å£°éŸ³
notification.soundName = UILocalNotificationDefaultSoundName;
// é€šçŸ¥å‚æ•°
NSDictionary *userDict = [NSDictionary dictionaryWithObject:self.alarmModel.geography forKey:@"key"];
notification.userInfo = userDict;

// ios8åï¼Œéœ€è¦æ·»åŠ è¿™ä¸ªæ³¨å†Œï¼Œæ‰èƒ½å¾—åˆ°æˆæƒ
if ([[UIApplication sharedApplication] respondsToSelector:@selector(registerUserNotificationSettings:)]) {
UIUserNotificationType type =  UIUserNotificationTypeAlert | UIUserNotificationTypeBadge | UIUserNotificationTypeSound;
UIUserNotificationSettings *settings = [UIUserNotificationSettings settingsForTypes:type
categories:nil];
[[UIApplication sharedApplication] registerUserNotificationSettings:settings];
// é€šçŸ¥é‡å¤æç¤ºçš„å•ä½ï¼Œå¯ä»¥æ˜¯å¤©ã€å‘¨ã€æœˆ
notification.repeatInterval = NSCalendarUnitDay;
} else {
// é€šçŸ¥é‡å¤æç¤ºçš„å•ä½ï¼Œå¯ä»¥æ˜¯å¤©ã€å‘¨ã€æœˆ
notification.repeatInterval = NSDayCalendarUnit;
}
// æ‰§è¡Œé€šçŸ¥æ³¨å†Œ
[[UIApplication sharedApplication] scheduleLocalNotification:notification];

}

}

- (void)receiveRabbitServicerMessage {

//    NSString *url5 = @"amqp://web_user:123@192.178.0.2:5672/device_log_2";
DebugLog(@"MQæœåŠ¡å™¨åœ°å€:%@",url5);
if (_conn == nil) {
_conn = [[RMQConnection alloc] initWithUri:url5 delegate:self];
}
[_conn start];
id&lt;RMQChannel&gt; ch = [_conn createChannel];
RMQExchange *x = [ch  direct:@"Mobile_Electric_Alarm" options:(RMQExchangeDeclareNoOptions)];
RMQQueue *q = [ch queue:@"" options:RMQQueueDeclareExclusive | RMQQueueDeclareAutoDelete];
[q bind:x routingKey:kUserInfo.company_id];
kweakSelf;
[q subscribe:^(RMQMessage * _Nonnull message) {
id result = [[NSString alloc] initWithData:message.body encoding:NSUTF8StringEncoding];
NSDictionary *dict = [self dictionaryWithJsonString:result];
if ([dict isKindOfClass:[NSDictionary class]]) {
weakSelf.alarmModel = [LXCustomAlarmModel mj_objectWithKeyValues:dict];
[weakSelf registerNotification:1];
}
}];
}

- (void)emitLogDirect:(NSString *)msg severity:(NSString *)severity {
//    NSString *url5 = @"amqp://web_user:123@192.178.0.2:5672/device_log_2";
DebugLog(@"MQå‘é€æœåŠ¡å™¨åœ°å€:%@",url5);
RMQConnection *conn = [[RMQConnection alloc] initWithUri:url5 delegate:self];
self.conn = conn;
[conn start];
id&lt;RMQChannel&gt; ch = [conn createChannel];
RMQExchange *x = [ch  direct:@"Mobile_Electric_Alarm" options:(RMQExchangeDeclareNoOptions)];
RMQQueue *q = [ch queue:@"" options:RMQQueueDeclareExclusive | RMQQueueDeclareAutoDelete];
[q bind:x routingKey:kUserInfo.company_id];
[x publish:[msg dataUsingEncoding:NSUTF8StringEncoding] routingKey:severity];
NSLog(@"Sent '%@'", msg);
[conn close];
}

#pragma mark - ç³»ç»Ÿçš„é€šçŸ¥ç›‘å¬
- (void)activeNotification:(NSNotification *)notification{
if (_conn == nil) {
//ç™»å½•æˆåŠŸ
if ([[LXUserInfoManger shareLXUserInfoManger].currentUserInfo.is_cloud isEqualToString:@"0"]) {
//MQæ¨é€
[self receiveRabbitServicerMessage];
}
}
}
- (void)backgroundNotification:(NSNotification *)notification{
[self closeConnection];
}

- (void)connection:(RMQConnection *)connection failedToConnectWithError:(NSError *)error {
if (error) {
NSLog(@"%@",error);
NSLog(@"è¿æ¥è¶…æ—¶");
[self closeConnection];

}else{

}
}
- (void)connection:(RMQConnection *)connection disconnectedWithError:(NSError *)error {
if (error) {
NSLog(@"%@",error);
}
else{
NSLog(@"è¿æ¥æˆåŠŸ");
}
}
- (void)willStartRecoveryWithConnection:(RMQConnection *)connection {
DebugLog(@"å°†è¦å¼€å§‹æ¢å¤é“¾æ¥");
}
- (void)startingRecoveryWithConnection:(RMQConnection *)connection {
DebugLog(@"å¼€å§‹æ¢å¤é“¾æ¥");

}

- (void)recoveredConnection:(RMQConnection *)connection {
DebugLog(@"æ¢å¤é“¾æ¥");

}
- (void)channel:(id&lt;RMQChannel&gt;)channel error:(NSError *)error {
if (error) {
NSLog(@"%@",error);
[self closeConnection];
}
}

//è·å–å½“å‰å±å¹•æ˜¾ç¤ºçš„viewcontrollerï¼Œå½“æ¥æ”¶åˆ°æ¨é€éœ€è¦è·³è½¬VC
- (UIViewController *)getCurrentVC {
UIViewController *rootViewController = [UIApplication sharedApplication].keyWindow.rootViewController;
UIViewController *currentVC = [self getCurrentVCFrom:rootViewController];
return currentVC;
}

- (UIViewController *)getCurrentVCFrom:(UIViewController *)rootVC {
UIViewController *currentVC;
if ([rootVC presentedViewController]) {
// è§†å›¾æ˜¯è¢«presentedå‡ºæ¥çš„
rootVC = [rootVC presentedViewController];
}
if ([rootVC isKindOfClass:[UITabBarController class]]) {
// æ ¹è§†å›¾ä¸ºUITabBarController
currentVC = [self getCurrentVCFrom:[(UITabBarController *)rootVC selectedViewController]];

} else if ([rootVC isKindOfClass:[UINavigationController class]]){
// æ ¹è§†å›¾ä¸ºUINavigationController
currentVC = [self getCurrentVCFrom:[(UINavigationController *)rootVC visibleViewController]];

} else {
// æ ¹è§†å›¾ä¸ºéå¯¼èˆªç±»
currentVC = rootVC;
}
return currentVC;
}
//æ¥æ”¶åˆ°æ¨é€ï¼Œjsonæ ¼å¼å­—ç¬¦ä¸²è½¬å­—å…¸ï¼šå› ä¸ºMQæ¨è¿‡æ¥çš„æ¶ˆæ¯æ˜¯ String ç±»å‹çš„
- (NSDictionary *)dictionaryWithJsonString:(NSString *)jsonString {

if (jsonString == nil) {
return nil;
}
NSData *jsonData = [jsonString dataUsingEncoding:NSUTF8StringEncoding];
NSError *err;
NSDictionary *dic = [NSJSONSerialization JSONObjectWithData:jsonData
options:NSJSONReadingMutableContainers
error:&amp;err];
if(err) {
NSLog(@"jsonè§£æå¤±è´¥ï¼š%@",err);
return nil;
}
return dic;

}
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="23-æœ¬åœ°å®‰è£…å¯åŠ¨mqæœåŠ¡">2.3 æœ¬åœ°å®‰è£…å¯åŠ¨MQæœåŠ¡</h3>

<p>å¦‚æœç”µè„‘å®‰è£… brew è½¯ä»¶åŒ…å·¥å…·çš„è¯ï¼Œæ‰§è¡Œå¹¶å¯åŠ¨</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>brew install rabbitmq

sudo ./rabbitmq-server

</pre></td></tr></tbody></table></code></pre></div></div>
<p>æµè§ˆå™¨è®¿é—®:localhost:15672,é»˜è®¤è´¦å·ä¸º:guest å¯†ç : guest</p>

<h2 id="ä¸‰rabbitmq-é‡åˆ°çš„é—®é¢˜">ä¸‰.RabbitMQ é‡åˆ°çš„é—®é¢˜</h2>

<h3 id="31-åœ°å€ä¸å¯¹connect-fail">3.1 åœ°å€ä¸å¯¹ï¼Œconnect fail</h3>
<blockquote>
  <p>Received connection: &lt;RMQConnection: 0x103fa1fc0&gt; disconnectedWithError: Error Domain=GCDAsyncSocketErrorDomain Code=7 â€œSocket closed by remote peerâ€ UserInfo={NSLocalizedDescription=Socket closed by remote peer}</p>
</blockquote>

<p>è§£å†³åŠæ³•ï¼šMQçš„é‰´æƒï¼ŒO-Cè·ŸJavaçš„æ ¼å¼ä¸å¤ªä¸€æ ·ï¼ŒJavaæ˜¯é€šè¿‡Name,Host,Ipç­‰ï¼ŒiOSçš„æ˜¯ç›´æ¥è®¾ç½®åœ°å€</p>

<blockquote>
  <p>amqps://user:pass@hostname:1234/myvhost</p>
</blockquote>

<p><strong>è¯´æ˜ï¼š</strong></p>

<ul>
  <li>åè®®å¤´ï¼šå¦‚æœæ˜¯Httpsçš„è¯ï¼Œåè®®ç”¨ï¼šamqpsï¼Œå¦‚æœæ˜¯Httpï¼Œç”¨amqp</li>
  <li>ç”¨æˆ·åï¼šuserName</li>
  <li>ç”¨æˆ·å¯†ç ï¼špassword</li>
  <li>ipåœ°å€ï¼š182.142.123ç­‰</li>
  <li>portç«¯å£ï¼š5672</li>
  <li>è™šæ‹Ÿä¸»æœºï¼šç”±åå°å®šä¹‰ï¼Œå¯æœ‰å¯æ— ï¼Œæ ¹æ®éœ€æ±‚ï¼Œmyloghost</li>
</ul>

<h3 id="32-æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯å‚æ•°é…ç½®æœ‰è¯¯æ¶ˆæ¯é˜Ÿåˆ—æŒä¹…åŒ–">3.2 æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯å‚æ•°é…ç½®æœ‰è¯¯,æ¶ˆæ¯é˜Ÿåˆ—æŒä¹…åŒ–</h3>

<blockquote>
  <p>Error Domain=com.rabbitmq.rabbitmq-objc-client Code=406 â€œPRECONDITION_FAILED - inequivalent arg â€˜durableâ€™ for queue â€˜Mobile_Electric_Alarmâ€™ in vhost â€˜device_log_2â€™: received â€˜falseâ€™ but current is â€˜trueâ€™â€ UserInfo={NSLocalizedDescription=PRECONDITION_FAILED - inequivalent arg â€˜durableâ€™ for queue â€˜Mobile_Electric_Alarmâ€™ in vhost â€˜device_log_2â€™: received â€˜falseâ€™ but current is â€˜trueâ€™}</p>
</blockquote>

<p>çœ‹3.3è§£å†³åŠæ³•</p>

<h3 id="33-mq-æ‰¾ä¸åˆ°å¯¹åº”çš„é˜Ÿåˆ—">3.3 MQ æ‰¾ä¸åˆ°å¯¹åº”çš„é˜Ÿåˆ—</h3>

<blockquote>
  <p>Error Domain=com.rabbitmq.rabbitmq-objc-client Code=404 â€œNOT_FOUND - no queue â€˜rmq-objc-client.gen-3B6E0E14-06E6-4AFC-B6E1-42A7F8FCD218-46927-00002C8AE36AB350â€™ in vhost â€˜device_log_2â€™â€ UserInfo={NSLocalizedDescription=NOT_FOUND - no queue â€˜rmq-objc-client.gen-3B6E0E14-06E6-4AFC-B6E1-42A7F8FCD218-46927-00002C8AE36AB350â€™ in vhost â€˜device_log_2â€™}</p>
</blockquote>

<p>è§£å†³åŠæ³•ï¼š</p>

<p>Exchange äº¤æ¢å™¨çš„é…ç½®å‚æ•°ï¼Œè·Ÿåå°çº¦å®šçš„ä¸ä¸€è‡´ï¼Œæœ‰æ—¶å€™åå°ä¹Ÿä¸çŸ¥é“è‡ªå·±é…ç½®çš„å•¥ï¼Œå°±éœ€è¦å°è¯•äº†ï¼›</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre>/**

typedef NS_OPTIONS(NSUInteger, RMQExchangeDeclareOptions) {
RMQExchangeDeclareNoOptions  = 0,
/// è¢«åŠ¨å£°æ˜
RMQExchangeDeclarePassive    = 1 &lt;&lt; 0,
///äº¤æ¢å™¨æŒä¹…åŒ–
RMQExchangeDeclareDurable    = 1 &lt;&lt; 1,
/// è‡ªåŠ¨é”€æ¯äº¤æ¢å™¨ï¼Œå½“æ‰€æœ‰çš„æ¶ˆæ¯é˜Ÿåˆ—éƒ½è¢«ä½¿ç”¨
RMQExchangeDeclareAutoDelete = 1 &lt;&lt; 2,
/// é…ç½®çš„äº¤æ¢å™¨å†…éƒ¨æ„é€ å¯¹åº”ç”¨å‘å¸ƒè€…ä¸å¯è§
RMQExchangeDeclareInternal   = 1 &lt;&lt; 3,
/// @brief
RMQExchangeDeclareNoWait     = 1 &lt;&lt; 4,
};*/
RMQExchange *x = [ch  direct:@"Mobile_Electric_Alarm" options:(RMQExchangeDeclareNoOptions)];
/** 
* é˜Ÿåˆ—çš„é…ç½®å¯é€‰å‚æ•°
* 
typedef NS_OPTIONS(NSUInteger, RMQQueueDeclareOptions) {
RMQQueueDeclareNoOptions  = 0,
/// è¢«åŠ¨å£°æ˜
RMQQueueDeclarePassive    = 1 &lt;&lt; 0,
/// é˜Ÿåˆ—æŒä¹…åŒ–
RMQQueueDeclareDurable    = 1 &lt;&lt; 1,
/// åªèƒ½è¢«å½“å‰çš„è¿æ¥æˆæƒè®¿é—®
RMQQueueDeclareExclusive  = 1 &lt;&lt; 2,
/// è‡ªåŠ¨åˆ é™¤
RMQQueueDeclareAutoDelete = 1 &lt;&lt; 3,
///
RMQQueueDeclareNoWait     = 1 &lt;&lt; 4,
};
*/
RMQQueue *q = [ch queue:@"" options:RMQQueueDeclareExclusive | RMQQueueDeclareAutoDelete];


</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚æœè¿æ¥æˆåŠŸåï¼Œé‚£ä¹ˆåœ¨MQçš„ç®¡ç†å°ï¼Œå°±å¯ä»¥çœ‹åˆ°å½“å‰è¿æ¥çš„æ¶ˆè´¹è€…äº†</p>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/%E5%9B%BE%E7%89%87.png" alt="ç®¡ç†å°å½“å‰è¿æ¥æ¶ˆè´¹è€…" /></p>

<p>[å‚è€ƒæ–‡ç« ]</p>

<p>1&gt; <a href="https://www.rabbitmq.com/tutorials/tutorial-one-objectivec.html">RabbbitMQå®˜ç½‘</a></p>

<p>2&gt; <a href="http://www.diggerplus.org/archives/3110">RabbitMQåŸºç¡€æ¦‚å¿µè¯¦ç»†ä»‹ç»</a></p>

<p>3&gt; <a href="https://www.jianshu.com/p/79ca08116d57">æ¶ˆæ¯é˜Ÿåˆ—ä¹‹ RabbitMQ</a></p>

<p>4&gt; <a href="https://www.jianshu.com/p/5c2d8af2c78e">RabbitMQâ€”â€”ç¬¬ä¸€ç¯‡ï¼šRabbitMQä»‹ç»</a></p>

<h2 id="äº¤æµè®¨è®º">äº¤æµè®¨è®º</h2>

<p>RabbitMQåœ¨iOSä¸­çš„ä½¿ç”¨èµ„æ–™å¾ˆå°‘ï¼Œå¦‚æœæœ‰é—®é¢˜çš„è¯ï¼Œæ¬¢è¿ç•™è¨€æ¢è®¨ï¼Œä¹Ÿå¯ä»¥åŠ æˆ‘QQ:1093034974</p>

<p>å¦å¤–ï¼Œå¦‚æœä½ è§‰å¾—æˆ‘çš„æ–‡ç« å¯¹ä½ æœ‰ä¸€å®šçš„å¸®åŠ©ï¼Œéå¸¸æ„Ÿè°¢èƒ½å¤Ÿç‚¹èµï¼Œè°¢è°¢ï¼</p>


                <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="åˆ†äº«åˆ°å¾®ä¿¡"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="åˆ†äº«åˆ°QQç©ºé—´"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="åˆ†äº«åˆ°æ–°æµªå¾®åš"></a><a href="#" class="bds_tqq" data-cmd="tqq" title="åˆ†äº«åˆ°è…¾è®¯å¾®åš"></a><a href="#" class="bds_twi" data-cmd="twi" title="åˆ†äº«åˆ°Twitter"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="åˆ†äº«åˆ°Facebook"></a></div>
                <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["weixin","qzone","tsina","tqq","twi","fbook"],"viewText":"åˆ†äº«åˆ°ï¼š","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["weixin","qzone","tsina","tqq","twi","fbook"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

                <hr style="visibility: hidden;">

            <!-- æ‰“èµåŠŸèƒ½ -->
            <div>
                <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
                <div>â˜›å…„deiï¼Œè¯·æˆ‘å–æ¯èŒ¶â˜š</div>
                <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
                    <span>æ‰“èµ</span>
                </button>
                <div id="QR" style="display: none;">
                        
                        
                <div id="wechat" style="display: inline-block">
                <img id="wechat_qr" src="/img/payimg/weipayimg.jpg" alt="yizibi å¾®ä¿¡æ”¯ä»˜"/>
                            <p>å¾®ä¿¡æ”¯ä»˜</p>
                </div>
                        
                        
                        
                <div id="alipay" style="display: inline-block">
                <img id="alipay_qr" src="/img/payimg/alipayimg.jpg" alt="yizibi æ”¯ä»˜å®"/>
                <p>æ”¯ä»˜å®</p>
                </div>
                        
                        
                        
                        
                </div>
                </div>
                
            </div>
            

   <!--  ä¸Šä¸€ç¯‡æˆ–è€…ä¸‹ä¸€ç¯‡postæŒ‰é’® -->
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2018/07/15/Mac-%E7%94%9F%E6%88%90%E7%9B%AE%E5%BD%95%E6%A0%91%E7%BB%93%E6%9E%84/" data-toggle="tooltip" data-placement="top" title="Mac ç”Ÿæˆç›®å½•æ ‘ç»“æ„">
                        Previous<br>
                        <span>Mac ç”Ÿæˆç›®å½•æ ‘ç»“æ„</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2018/09/10/iOS%E7%BB%99%E4%B8%80%E5%BC%A0%E5%9B%BE%E7%89%87%E6%B7%BB%E5%8A%A0%E5%B8%A6%E6%9C%89%E9%9B%B7%E8%BE%BE%E6%95%88%E6%9E%9C%E7%9A%84%E6%A0%87%E8%AE%B0-%E7%B1%BB%E4%BC%BC%E5%9C%B0%E5%9B%BE%E6%A0%87%E8%AE%B0%E4%BD%8D%E7%BD%AE/" data-toggle="tooltip" data-placement="top" title="iOSç»™ä¸€å¼ å›¾ç‰‡æ·»åŠ å¸¦æœ‰é›·è¾¾æ•ˆæœçš„æ ‡è®°ï¼Œç±»ä¼¼åœ°å›¾æ ‡è®°ä½ç½®">
                        Next<br>
                        <span>iOSç»™ä¸€å¼ å›¾ç‰‡æ·»åŠ å¸¦æœ‰é›·è¾¾æ•ˆæœçš„æ ‡è®°ï¼Œç±»ä¼¼åœ°å›¾æ ‡è®°ä½ç½®</span>
                        </a>
                    </li>
                    
                </ul>


<!--                -->

                
                
                <!--   gitalk       -->
                
            </div>  

    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
        				
                            
                				<a href="/tags/#iOSæŠ€æœ¯" title="iOSæŠ€æœ¯" rel="13">
                                    iOSæŠ€æœ¯
                                </a>
                            
        				
                            
                				<a href="/tags/#iOSé—®é¢˜" title="iOSé—®é¢˜" rel="2">
                                    iOSé—®é¢˜
                                </a>
                            
        				
                            
                				<a href="/tags/#VPS" title="VPS" rel="2">
                                    VPS
                                </a>
                            
        				
                            
                				<a href="/tags/#å·¥å…·" title="å·¥å…·" rel="6">
                                    å·¥å…·
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#ç”Ÿæ´»" title="ç”Ÿæ´»" rel="3">
                                    ç”Ÿæ´»
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#Linux" title="Linux" rel="2">
                                    Linux
                                </a>
                            
        				
                            
                				<a href="/tags/#åšå®¢" title="åšå®¢" rel="3">
                                    åšå®¢
                                </a>
                            
        				
                            
                				<a href="/tags/#éšç¬”" title="éšç¬”" rel="2">
                                    éšç¬”
                                </a>
                            
        				
                            
                				<a href="/tags/#æ‘„å½±" title="æ‘„å½±" rel="2">
                                    æ‘„å½±
                                </a>
                            
        				
                            
                				<a href="/tags/#æ—…è¡Œ" title="æ—…è¡Œ" rel="2">
                                    æ—…è¡Œ
                                </a>
                            
        				
        			</div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">
                    
                        <li><a href="https://blog.searchinfogo.com">Junhua's Blog</a></li>
                    
                        <li><a href="http://ilongge.cn/">åŸè´¥ç¬ç­±é¾™</a></li>
                    
                        <li><a href="http://tombraiderjf.com/">Lara Croft</a></li>
                    
                        <li><a href="http://srsyrzz.ml/">è€€æ—¥åº„ä¸»çš„åšå®¢</a></li>
                    
                        <li><a href="https://leohope.com/">Hope</a></li>
                    
                        <li><a href="https://www.chairyfish.com/">äº”æ–¤</a></li>
                    
                        <li><a href="https://asdfv1929.github.io/">asdfv1929</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
    

    
</article>


<!-- Add support for Mathjax by Voleking-->




<section class="post-comments">
    
    <div id="disqus_thread"></div>
    <script>
        
        var disqus_config = function () {
            this.page.url = "http://localhost:4000/2018/08/14/RabbitMQ%E5%9C%A8iOS%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/";
            this.page.identifier = "/2018/08/14/RabbitMQ%E5%9C%A8iOS%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/";
        };
    
    var disqus_shortname = 'yizibi';
    
    (function() { // DON'T EDIT BELOW THIS LINE
     var d = document, s = d.createElement('script');
     s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
     s.setAttribute('data-timestamp', +new Date());
     (d.head || d.body).appendChild(s);
     })();
        </script>
    <noscript>è¦æŸ¥çœ‹<a href="http://disqus.com/?ref_noscript"> Disqus </a>è¯„è®ºï¼Œè¯·å¯ç”¨ JavaScript</noscript>
    
    
    
    
    
</section>







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<!--
Author: Ray-Eldath
refer to:
 - https://github.com/theme-next/hexo-theme-next/blob/master/source/js/src/utils.js
 - https://jingyan.baidu.com/article/b2c186c83ec846c46ef6ff80.html
 - http://www.bkjia.com/jQuery/449205.html
-->
<style media="screen">
  .scroll {
    z-index: 10000;
    display: none;
    height: 24px;
    background: #222;
    color: #fff;
    line-height: 24px;
    text-align: center;
    position: fixed;
    right: 30px;
    bottom: 30px;
    cursor: pointer;
    font-size: 14px;
  }
</style>
<div class="scroll">
  <i class="fa fa-arrow-up" style="margin-left: 4px"></i>
  <span class="scrollpercent" style="margin-left: -2px"></span>
  <span style="margin-left: -4px; margin-right: 4px">%</span>
</div>

<script src="/js/util.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    if (utils.isMobile()) {
      $('.scroll').hide();
      return;
    }
    $(window).scroll(function() {
      let scrollValue = $(window).scrollTop();
      var scrollPercentRounded = Math.round((scrollValue / utils.getContentVisibilityHeight()) * 100);
      var scrollPercentMaxed = (scrollPercentRounded > 100) ? 100 : scrollPercentRounded;
      $('.scrollpercent').html(scrollPercentMaxed);
      scrollValue > 100 ? $('.scroll').fadeIn() : $('.scroll').fadeOut();
    });
    $('.scroll').click(function() {
      $('html, body').animate({
        scrollTop: 0
      }, 300);
    })
  })
</script>


<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://twitter.com/yizibi">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/li-lin-fei">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">çŸ¥</i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="http://weibo.com/2524618644">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    


                    
                    <li>
                        <a target="_blank" href="https://www.facebook.com/yizibbi">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/yizibi">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/éœ²é‘«-æ-525b58111">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">
<!--                  æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡ï¼Œæœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡ï¼Œæœ¬æ–‡æ€»é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>æ¬¡-->
                    <span class="site-uv" title="æ€»ç‚¹å‡»äººæ•°">
                    <img src="/img/vendor/octicons/svg/person.svg" width="10" height="16">
                    <span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
                    &nbsp;&nbsp;|&nbsp;&nbsp;
                    <span class="site-pv" title="æ€»ç‚¹å‡»é‡">
                    <img src="/img/vendor/octicons/svg/eye.svg" width="16" height="16">
                    <span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
                    &nbsp;&nbsp;|&nbsp;&nbsp;
                    <span class="page-pv"title="æœ¬é¡µé¢ç‚¹å‡»äººæ•°">
                    <img src="/img/vendor/octicons/svg/file-text.svg" width="12" height="16">
                    <span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span>
                    <br>
                    Copyright &copy; ä¸€ä¹‹ç¬” 2018
                    <br>
                    Theme by <a href="https://github.com/Huxpro/huxpro.github.io">Hux</a> | æœ¬ç«™æºç  <a href="https://github.com/yizibi/yizibi.github.io">yizibi</a>
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=yizibi&repo=yizibi.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
            
        </div>
    </div>
</footer>
<!--ç½‘ç«™ç»Ÿè®¡-->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Service Worker -->


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async('/js/jquery.tagcloud.js',function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-124793396-1';
    var _gaDomain = 'auto';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->



<!-- Side Catalog -->



<!-- Multi-Lingual -->




<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

<script src="/js/jquery.min.js"></script>
<style>
.videoWrapper {
	position: relative;
	padding-bottom: 56.333%;
	height: 0;
    background: black;
}
.videoWrapper iframe {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
    border: 0;
}    
</style>

<script>
function get_youtube_id(url) {
    var p = /^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;
    return (url.match(p)) ? RegExp.$1 : false;
}
function vimeo_embed(url,el) {
    var id = false;
    $.ajax({
      url: 'https://vimeo.com/api/oembed.json?url='+url,
      async: true,
      success: function(response) {
        if(response.video_id) {
          id = response.video_id;
          if(url.indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
          if(url.indexOf('loop=1') !== -1) var loop=1; else var loop=0;
          var theInnerHTML = '<div class="videoWrapper"><iframe src="https://player.vimeo.com/video/'+id+'/?byline=0&title=0&portrait=0';
          if(autoplay==1) theInnerHTML += '&autoplay=1';
          if(loop==1) theInnerHTML += '&loop=1';
          theInnerHTML += '" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>'; 
          el.innerHTML = theInnerHTML;
        }
      }
    });
}
function video_embed() {
    var p = document.getElementsByTagName('p');
    for(var i = 0; i < p.length; i++) {
        //check if this is an external url (that starts with https:// or http://
        if (p[i].innerHTML.indexOf("http://") == 0 ||
            p[i].innerHTML.indexOf("https://") == 0) {
            var youtube_id = get_youtube_id(p[i].innerHTML);
            if(youtube_id) {
                if(p[i].innerHTML.indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
                if(p[i].innerHTML.indexOf('loop=1') !== -1) var loop=1; else var loop=0;
                var theInnerHTML = '<div class="videoWrapper"><iframe width="720" height="420" src="https://www.youtube.com/embed/' + youtube_id + '?rel=0&showinfo=0';
                if(autoplay==1) theInnerHTML += '&autoplay=1';
                if(loop==1) theInnerHTML += '&loop=1&playlist='+youtube_id+'&version=3';
                theInnerHTML += '" frameborder="0" allowfullscreen></iframe></div>';
                p[i].innerHTML = theInnerHTML;
            }
            if(p[i].innerHTML.indexOf('vimeo.com') !== -1) {
                //ask vimeo for the id and place the embed
                vimeo_embed(p[i].innerHTML,p[i]);
            }
        }
    }
}
video_embed();

function mp3_embed() {
    var p = document.getElementsByTagName('p');
    for(var i = 0; i < p.length; i++) {
        if(p[i].innerHTML.indexOf('.mp3') !== -1) {
            var str = p[i].innerHTML.split('?');
            if(str.length == 1) str[1] = '';
            var str1 = str[1];
            str1 = str1.replace('&','').replace('&','');
            str1 = str1.replace('autoplay=1','').replace('autoplay=0','');
            str1 = str1.replace('loop=1','').replace('loop=0','');
            str1 = str1.replace('controls=0','').replace('controls=1','');

            if (str[0].lastIndexOf('.mp3', str[0].length - 4) === str[0].length - 4 && str1.length == 0) {
                if(str[1].indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
                if(str[1].indexOf('loop=1') !== -1) var loop=1; else var loop=0;
                if(str[1].indexOf('controls=0') !== -1) var controls=0; else var controls=1;
                var newInnerHTML = '<audio';
                if(autoplay==1) newInnerHTML += ' autoplay';
                if(loop==1) newInnerHTML += ' loop';
                if(controls==1) newInnerHTML += ' controls';
                newInnerHTML += '><source src="'+str[0]+'" type="audio/mpeg">Your browser does not support the audio element.</audio>';
                p[i].innerHTML = newInnerHTML;
            }
        }
    }
}
mp3_embed();
</script>

<!--é¼ æ ‡ç‚¹å‡»çˆ±å¿ƒåŠ¨ç”»-->
<script type="text/javascript" src="/js/src/love.js"></script>

</body>

</html>
