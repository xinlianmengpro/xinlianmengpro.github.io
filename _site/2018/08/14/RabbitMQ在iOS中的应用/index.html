<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="iOS 开发 公司合伙人 | 李露鑫，iOS & Photography Lover，Software Engineer，Entrepreneur | 这里是 一之笔 @Yizibbi 李露鑫 的个人博客， 生活需要仪式感，💪。">
    <meta name="keywords"  content="李露鑫, Yizibi,yizibi,一之笔的博客,一之笔,一支笔, iOS, 公司合伙人, @yizibi, @yizibi的博客, 博客, 个人网站, 互联网">
    <meta name="theme-color" content="#000000">
    
    <!-- Open Graph -->
    <meta property="og:title" content="RabbitMQ在iOS中的应用 - 一之笔的博客 | Yizibi Blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="文章原创如需转载，请注明出处”本文首发于一之笔”;

">
    
    <meta property="article:published_time" content="2018-08-14T06:32:24Z">
    
    
    <meta property="article:author" content="一之笔">
    
    
    <meta property="article:tag" content="iOS技术">
    
    
    <meta property="og:image" content="http://localhost:4000/img/avatar-hux-ny.jpg">
    <meta property="og:url" content="http://localhost:4000/2018/08/14/RabbitMQ%E5%9C%A8iOS%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/">
    <meta property="og:site_name" content="一之笔的博客 | Yizibi Blog">
    
    <title>RabbitMQ在iOS中的应用 - 一之笔的博客 | Yizibi Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/2018/08/14/RabbitMQ%E5%9C%A8iOS%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>

<script type="text/javascript" color="238,205,205" opacity='0.7' zIndex="-2" count="99" src="../../../../js/canvas-nest.min.js"></script>
<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">一之笔</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    
                    <li>
                        <a href="/archive/">Archive</a>
                    </li>
                    
                    <li>
                        <a href="/portfolio/">Portfolio</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/home-bg-o.jpg" width="0" height="0"> -->

<!-- Post Header -->
<!-- canvas-nest.min.js -->
<!--<script type="text/javascript" src="../../../../js/canvas-nest.min.js"></script>-->
<head>
    <link href="../../../../css/rouge.css" rel="stylesheet">
</head>
<script type="text/javascript" color="238,205,205" opacity='0.7' zIndex="-2" count="99" src="../../../../js/canvas-nest.min.js"></script>
<!--//添加评论系统-->
<link rel="stylesheet" href="../../../../css/gitalk.css">
    <script src="../../../../js/gitalk.min.js"></script>
<!--    打赏-->
<link href="/css/reward.css?v=6.2.0" rel="stylesheet" type="text/css" />

<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/home-bg-o.jpg')
    }

    
</style>
<header class="intro-header" >
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#iOS技术" title="iOS技术">iOS技术</a>
                        
                    </div>
                    <h1>RabbitMQ在iOS中的应用</h1>
                    
                    
                    <h2 class="subheading">RabbitMQ</h2>
                    
                    <span class="meta">Posted by 一之笔 on August 14, 2018</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                


				<p>文章原创如需转载，请注明出处”本文首发于<a href="https://yizibi.github.io/">一之笔</a>”;</p>

<p>引言</p>

<blockquote>
  <p>随着公司业务的需要，原来的推送，不能满足现有的要求，比如，有的公司需要局域网部署平台服务，不能访问外网，意味着，通过自带的 APNS远程推送服务，基本上就挂掉了;再比如，公司的某一个业务，需要实时刷新数据，如股票价格，报警实时监测数据等这种场景。这时候，就需要另辟蹊径；当然，我们有很多种选择，比如，RabbitMQ-实现了高级消息队列协议的开源消息代理软件，为啥要用这个呢，因为Android已经用这个做好了，所以，iOS 也没有其他选择了;</p>
</blockquote>

<p>在集成客户端的时候，我们有一些概念需要知道，如消息队列，生产者，消费者，交换器，队列,通道等；</p>

<h2 id="一rabbitmq-的相关概念">一.RabbitMQ 的相关概念</h2>

<h3 id="11-简介">1.1 简介</h3>

<p>RabbitMQ 本质上是 MB（Message Broker) 消息代理，可以这么认为，<a href="https://www.rabbitmq.com/tutorials/tutorial-one-objectivec.html">RabbitMQ</a>就像一个 “邮局”，负责收发存储邮包（消息），唯一与邮局不同的是，它不会处理消息内容</p>

<p>==AMQP==，即Advanced Message Queuing Protocol，高级消息队列协议，是应用层协议的一个开放标准；类似Http,https,STMP这种，我们只需要知道，他是一个协议，实际开发中会遇到，底层实现我们不用管；</p>

<h3 id="12-mq的特征">1.2 MQ的特征</h3>

<p>RabbitMQ 是一个由 Erlang 语言开发的 AMQP 的开源实现。</p>

<p>支持多种客户端，如：==Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP，Object-C, Swift==等，支持AJAX。用于在分布式系统中存储转发消息，在易用性、扩展性、高可用性等方面表现不俗。</p>

<ul>
  <li>可靠性（Reliability）</li>
</ul>

<p>RabbitMQ 使用一些机制来保证可靠性，如持久化、传输确认、发布确认。</p>

<ul>
  <li>灵活的路由（Flexible Routing）</li>
</ul>

<p>在消息进入队列之前，通过 Exchange 来路由消息的。对于典型的路由功能，RabbitMQ 已经提供了一些内置的 Exchange 来实现。针对更复杂的路由功能，可以将多个 Exchange 绑定在一起，也通过插件机制实现自己的 Exchange 。</p>

<ul>
  <li>消息集群（Clustering）</li>
</ul>

<p>多个 RabbitMQ 服务器可以组成一个集群，形成一个逻辑 Broker 。</p>

<ul>
  <li>高可用（Highly Available Queues）</li>
</ul>

<p>队列可以在集群中的机器上进行镜像，使得在部分节点出问题的情况下队列仍然可用。</p>

<ul>
  <li>多种协议（Multi-protocol）</li>
</ul>

<p>RabbitMQ 支持多种消息队列协议，比如 STOMP、MQTT 等等。</p>

<ul>
  <li>多语言客户端（Many Clients）</li>
</ul>

<p>RabbitMQ 几乎支持所有常用语言，比如 Java、.NET、Ruby, Object-C等等。</p>

<ul>
  <li>管理界面（Management UI）</li>
</ul>

<p>RabbitMQ 提供了一个易用的用户界面，使得用户可以监控和管理消息 Broker 的许多方面。</p>

<ul>
  <li>跟踪机制（Tracing）</li>
</ul>

<p>如果消息异常，RabbitMQ 提供了消息跟踪机制，使用者可以找出发生了什么。</p>

<ul>
  <li>插件机制（Plugin System）</li>
</ul>

<p>RabbitMQ 提供了许多插件，来从多方面进行扩展，也可以编写自己的插件。</p>

<h3 id="13-rabbitmq的概念模型">1.3 RabbitMQ的概念模型</h3>

<p>所有 MQ 产品从模型抽象上来说都是一样的过程：
消费者（consumer）订阅某个队列。生产者（producer）创建消息，然后发布到队列（queue）中，最后将消息发送到监听的消费者。</p>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/MQ-sendMessage.png" alt="消息模型" /></p>

<ul>
  <li>AMQP的内部结构</li>
</ul>

<p>上面介绍RabbitMQ是AMQP的实现，所以其内部也是AMQP的概念</p>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/MQ/AMQP-image.png" alt="RabbbitMQ的内部结构" /></p>

<ul>
  <li>P(Producer) 生产者，有的也称之为 Publisher,消息的发布者</li>
</ul>

<p>发送消息的程序或者代码就是生产者，一般是 服务端</p>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/MQ-producer.png" alt="生产者" /></p>

<ul>
  <li>Exchange(交换器)</li>
</ul>

<p>交换器，用来接收生产者发送的消息并将这些消息路由给服务器中的队列.生产者把消息发布到 Exchange 上，消息最终到达队列并被消费者接收，而 Binding 决定交换器的消息应该发送到那个队列。</p>

<ul>
  <li>routing key</li>
</ul>

<p>生产者在将消息发送给Exchange的时候，一般会指定一个routing key，来指定这个消息的路由规则，而这个routing key需要与Exchange Type及binding key联合使用才能最终生效。
在Exchange Type与binding key固定的情况下（在正常使用时一般这些内容都是固定配置好的），我们的生产者就可以在发送消息给Exchange时，通过指定routing key来决定消息流向哪里。
RabbitMQ为routing key设定的长度限制为255 bytes。
此外，这个 Key 值，一般是服务端跟客户端约定好的，可以是组织ID，也可以用ID</p>

<ul>
  <li>Binding(绑定)</li>
</ul>

<p>绑定，用于消息队列和交换器之间的关联。一个绑定就是基于路由键将交换器和消息队列连接起来的路由规则，所以可以将交换器理解成一个由绑定构成的路由表。</p>

<ul>
  <li>Queue(队列)</li>
</ul>

<p>消息队列，用来保存消息直到发送给消费者。它是消息的容器，也是消息的终点。一个消息可投入一个或多个队列。消息一直在队列里面，等待消费者连接到这个队列将其取走。</p>

<ul>
  <li>Connection(连接)</li>
</ul>

<p>网络连接，比如一个TCP连接，RabbitMQ的OC CLient就是封装了 开源的TCP实现<a href="https://github.com/robbiehanson/CocoaAsyncSocket">CocoaAsyncSocket</a></p>

<ul>
  <li>Channel(信道)</li>
</ul>

<p>信道，多路复用连接中的一条独立的双向数据流通道。信道是建立在真实的TCP连接内地虚拟连接，AMQP 命令都是通过信道发出去的，不管是发布消息、订阅队列还是接收消息，这些动作都是通过信道完成。因为对于操作系统来说建立和销毁 TCP 都是非常昂贵的开销，所以引入了信道的概念，以复用一条 TCP 连接。</p>

<ul>
  <li>
    <p>Virtual Host(虚拟主机)
虚拟主机，表示一批交换器、消息队列和相关对象。虚拟主机是共享相同的身份认证和加密环境的独立服务器域。每个 vhost 本质上就是一个 mini 版的 RabbitMQ 服务器，拥有自己的队列、交换器、绑定和权限机制。vhost 是 AMQP 概念的基础，必须在连接时指定，RabbitMQ 默认的 vhost 是 /</p>
  </li>
  <li>
    <p>C(Consumer) 消费者</p>
  </li>
</ul>

<p>订阅某个队列，消息的接受者</p>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/MQ-consumer.png" alt="消费者" /></p>

<h3 id="14-rabbitmq-中的消息路由">1.4 RabbitMQ 中的消息路由</h3>
<p>生产者把消息发布到 Exchange 上，消息最终到达队列并被消费者接收，而 Binding 决定交换器的消息应该发送到那个队列。</p>

<p>在绑定（Binding）Exchange与Queue的同时，一般会指定一个binding key；生产者将消息发送给Exchange时，一般会指定一个routing key；当binding key与routing key相匹配时，消息将会被路由到对应的Queue中。
在绑定多个Queue到同一个Exchange的时候，这些Binding允许使用相同的binding key。
binding key 并不是在所有情况下都生效，它依赖于Exchange Type，比如fanout类型的Exchange就会无视binding key，而是将消息路由到所有绑定到该Exchange的Queue。</p>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/MQ/MQroute.png" alt="AMOP的消息路由" /></p>

<h3 id="15-rabbitmq-的exchange-types">1.5 RabbitMQ 的Exchange Types</h3>

<p>RabbitMQ常用的Exchange Type有==fanout==、==direct==、==topic==、==headers==这四种（AMQP规范里还提到两种Exchange Type，分别为system与自定义，这里不予以描述），headers 匹配 AMQP 消息的 header 而不是路由键，此外 headers 交换器和 direct 交换器完全一致，但性能差很多，目前几乎用不到了，所以直接看另外三种类型：</p>

<ul>
  <li>direct</li>
</ul>

<p>direct类型的Exchange路由规则也很简单，它会把消息路由到那些binding key与routing key完全匹配的Queue中。</p>

<p>相关代码如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>/** 创建信道 */
id&lt;RMQChannel&gt; ch = [_conn createChannel];
/** 创建交换器，direct方法，这个需要跟后台保持一致，包括交换器的名称，也要跟后台约定好，还有配置选项，是否持久化等 */
RMQExchange *x = [ch  direct:@"Mobile_Alarm" options:(RMQExchangeDeclareNoOptions)];
/** 创建队列，如果不指定队列名称，MQ会默认自动创建一个队列，前缀以 `rmq-objc-client.gen-` 开头 */
RMQQueue *q = [ch queue:@"" options:RMQQueueDeclareExclusive | RMQQueueDeclareAutoDelete];
/** 队列绑定交换器，并指定 rountKey，需要跟后台指定相同的规则，可以是用户ID等 */
[q bind:x routingKey:@"5"];

</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/MQ-Direct.png" alt="Exchange Direct类型" /></p>

<ul>
  <li>fanout
这种类型的Exchange,就是群发，此exchange的路由规则很简单直接将消息路由到所有绑定的队列中，无须对消息的routingkey进行匹配操作。</li>
</ul>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/MQ%20fanout.png" alt="Exchange fanout类型" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre>/**  需要注意：&lt;RMQConnectionDelegate&gt; 如果创建连接，指定代理是 当前class,那么当前class需要遵守连接的代理协议，并实现相关代理方法*/

/** 创建连接 */
RMQConnection *conn = [[RMQConnection alloc] initWithUri:url5 delegate:self];
[conn start];
/** 创建信道 */
id&lt;RMQChannel&gt; ch = [conn createChannel];
/** 创建交换器 */
RMQExchange *x = [ch fanout:@"Alarm"];
RMQQueue *q = [ch queue:@"" options:RMQQueueDeclareExclusive];
/** 绑定交换器 */
[q bind:x];
/** 订阅消息 */
[q subscribe:^(RMQMessage * _Nonnull message) {
NSLog(@"Received %@", [[NSString alloc] initWithData:message.body encoding:NSUTF8StringEncoding]);
}];

///socket 连接失败回调，超时或者地址有误
- (void)connection:(RMQConnection *)connection failedToConnectWithError:(NSError *)error;
/// 没有连接成功回调
- (void)connection:(RMQConnection *)connection disconnectedWithError:(NSError *)error;
/// 自动恢复连接调用
- (void)willStartRecoveryWithConnection:(RMQConnection *)connection;
/// 正在开始恢复连接
- (void)startingRecoveryWithConnection:(RMQConnection *)connection;
/// 已经恢复连接的时候，调用
- (void)recoveredConnection:(RMQConnection *)connection;
/// 连接过程中，信道异常调用
- (void)channel:(id&lt;RMQChannel&gt;)channel error:(NSError *)error;
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>Topic</li>
</ul>

<p>前面讲到direct类型的Exchange路由规则是完全匹配binding key与routing key，但这种严格的匹配方式在很多情况下不能满足实际业务需求。topic类型的Exchange在匹配规则上进行了扩展，它与direct类型的Exchage相似，也是将消息路由到binding key与routing key相匹配的Queue中，但这里的匹配规则有些不同，它约定：</p>

<blockquote>
  <p>routing key为一个句点号“. ”分隔的字符串（我们将被句点号“. ”分隔开的每一段独立的字符串称为一个单词），如“device.userId”、“alarm.type”，
binding key与routing key一样也是句点号“. ”分隔的字符串
binding key中可以存在两种特殊字符“<em>”与“#”，用于做模糊匹配，其中“</em>”用于匹配一个单词，“#”用于匹配多个单词（可以是零个）</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>RMQConnection * connection = [[RMQConnection alloc] initWithUri:url delegate:[RMQConnectionDelegateLogger new]];
[connection start];
id&lt;RMQChannel&gt;channel = [connection createChannel];
RMQExchange * exchange = [channel topic:@"topic_logs" options:RMQExchangeDeclarePassive];
[exchange publish:finalData routingKey:[NSString stringWithFormat:@"device.%@",didStr]];
[connection close];

</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/MQ%20topic%20Type.png" alt="Topic 类型" /></p>

<p>以上图中的配置为例，routingKey=”dev.alarm.device”的消息会同时路由到QA与QB，routingKey=”dev.alarm.type”的消息会路由到QA，routingKey=”lazy.brown.fox”的消息会路由到Q2，routingKey=”water.type.ID”的消息会路由到QB；routingKey=”device.user.water”、routingKey=”alarmtype”的消息将会被丢弃，因为它们没有匹配任何bindingKey。</p>

<h2 id="二rabbitmq-的集成">二.RabbitMQ 的集成</h2>

<h3 id="21-客户端集成">2.1 客户端集成</h3>

<p><a href="https://github.com/rabbitmq/rabbitmq-objc-client">RabbitMQ官方Git仓库</a></p>

<ul>
  <li>我用的是CocoaPods集成,在 podfile 中添加：</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>pod 'RMQClient'

</pre></td></tr></tbody></table></code></pre></div></div>

<p>注意：</p>

<p>RabbitMQ pod 内部有 <a href="https://github.com/robbiehanson/CocoaAsyncSocket">CocoaAsyncSocket</a>,如果项目中，已经集成了，需要删除多余的</p>

<h3 id="22-源代码文件">2.2 源代码文件</h3>

<p>考虑到客户端架构的特殊性，需要将MQ消息订阅封装成一个工具,并配置为 单例 模式。</p>

<blockquote>
  <p>导入头文件  #import <RMQClient.h></RMQClient.h></p>
</blockquote>

<p>LXCustomRabbitMQManger.h</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>//开始订阅消息
- (void)startScribeMessage;
//关闭连接
- (void)closeConnection;
</pre></td></tr></tbody></table></code></pre></div></div>
<p>LXCustomRabbitMQManger.m</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
</pre></td><td class="rouge-code"><pre>@interface LXCustomRabbitMQManger()&lt;RMQConnectionDelegate&gt;

@property (nonatomic,strong) RMQConnection *conn;
@property (nonatomic,strong) LXCustomAlarmModel *alarmModel;

@end


- (void)startScribeMessage {
[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(activeNotification:) name:UIApplicationDidBecomeActiveNotification object:nil];
[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(backgroundNotification:) name:UIApplicationDidEnterBackgroundNotification object:nil];
}

- (void)closeConnection {
if (_conn) {
[self.conn close];
self.conn = nil;
}
}

//创建本地推送
- (void)registerNotification:(NSInteger )alerTime {
kweakSelf;
kStrongSelf;
// 使用 UNUserNotificationCenter 来管理通知
if (@available(iOS 10.0, *)) {
// 使用 UNUserNotificationCenter 来管理通知
UNUserNotificationCenter* center = [UNUserNotificationCenter currentNotificationCenter];
//需创建一个包含待通知内容的 UNMutableNotificationContent 对象，注意不是 UNNotificationContent ,此对象为不可变对象。
UNMutableNotificationContent* content = [[UNMutableNotificationContent alloc] init];
content.title = [NSString localizedUserNotificationStringForKey:self.alarmModel.alarm_type arguments:nil];
content.body = [NSString localizedUserNotificationStringForKey:self.alarmModel.geography
arguments:nil];
content.sound = [UNNotificationSound defaultSound];

// 在 alertTime 后推送本地推送
UNTimeIntervalNotificationTrigger* trigger = [UNTimeIntervalNotificationTrigger
triggerWithTimeInterval:alerTime repeats:NO];
UNNotificationRequest* request = [UNNotificationRequest requestWithIdentifier:@"FiveSecond"
content:content trigger:trigger];
//添加推送成功后的处理！
[center addNotificationRequest:request withCompletionHandler:^(NSError * _Nullable error) {
/*
DQAlertView *reservationAlert = [[DQAlertView alloc] initWithTitle:self.alarmModel.alarm_type
message:self.alarmModel.geography
delegate:self cancelButtonTitle:@"取消"
otherButtonTitles:@"确定"];

reservationAlert.shouldDimBackgroundWhenShowInView = YES;
reservationAlert.shouldDismissOnOutsideTapped = YES;
[reservationAlert show];
[reservationAlert actionWithBlocksCancelButtonHandler:^{


} otherButtonHandler:^{
//跳转
LXDeviceAlarmModel *alarmIDModel = [[LXDeviceAlarmModel alloc] init];
alarmIDModel.ID = strongSelf.alarmModel.ID;
LXDeviceDetailController *deviceDetailVC = [[LXDeviceDetailController alloc] init];
deviceDetailVC.deviceDealType = KearlyNoDealType;
deviceDetailVC.deviceAlarm = alarmIDModel;
[[self getCurrentVC].navigationController pushViewController:deviceDetailVC animated:YES];

}];
*/
UIAlertController *alert = [UIAlertController alertControllerWithTitle:self.alarmModel.alarm_type message:self.alarmModel.geography preferredStyle:UIAlertControllerStyleAlert];
UIAlertAction *cancelAction = [UIAlertAction actionWithTitle:@"取消" style:UIAlertActionStyleCancel handler:nil];
UIAlertAction *confirmAction = [UIAlertAction actionWithTitle:@"确定" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
LXDeviceAlarmModel *alarmIDModel = [[LXDeviceAlarmModel alloc] init];
alarmIDModel.ID = strongSelf.alarmModel.ID;
LXDeviceDetailController *deviceDetailVC = [[LXDeviceDetailController alloc] init];
deviceDetailVC.deviceDealType = KearlyNoDealType;
deviceDetailVC.deviceAlarm = alarmIDModel;
[[self getCurrentVC].navigationController pushViewController:deviceDetailVC animated:YES];
}];
[alert addAction:cancelAction];
[alert addAction:confirmAction];
[[UIApplication sharedApplication].keyWindow.rootViewController presentViewController:alert animated:YES completion:nil];

}];
}
else {
UILocalNotification *notification = [[UILocalNotification alloc] init];
// 设置触发通知的时间
NSDate *fireDate = [NSDate dateWithTimeIntervalSinceNow:1];
NSLog(@"fireDate=%@",fireDate);

notification.fireDate = fireDate;
// 时区
notification.timeZone = [NSTimeZone defaultTimeZone];
// 设置重复的间隔
notification.repeatInterval = kCFCalendarUnitSecond;

// 通知内容
notification.alertBody =  self.alarmModel.alarm_type;
notification.applicationIconBadgeNumber = 1;
// 通知被触发时播放的声音
notification.soundName = UILocalNotificationDefaultSoundName;
// 通知参数
NSDictionary *userDict = [NSDictionary dictionaryWithObject:self.alarmModel.geography forKey:@"key"];
notification.userInfo = userDict;

// ios8后，需要添加这个注册，才能得到授权
if ([[UIApplication sharedApplication] respondsToSelector:@selector(registerUserNotificationSettings:)]) {
UIUserNotificationType type =  UIUserNotificationTypeAlert | UIUserNotificationTypeBadge | UIUserNotificationTypeSound;
UIUserNotificationSettings *settings = [UIUserNotificationSettings settingsForTypes:type
categories:nil];
[[UIApplication sharedApplication] registerUserNotificationSettings:settings];
// 通知重复提示的单位，可以是天、周、月
notification.repeatInterval = NSCalendarUnitDay;
} else {
// 通知重复提示的单位，可以是天、周、月
notification.repeatInterval = NSDayCalendarUnit;
}
// 执行通知注册
[[UIApplication sharedApplication] scheduleLocalNotification:notification];

}

}

- (void)receiveRabbitServicerMessage {

//    NSString *url5 = @"amqp://web_user:123@192.178.0.2:5672/device_log_2";
DebugLog(@"MQ服务器地址:%@",url5);
if (_conn == nil) {
_conn = [[RMQConnection alloc] initWithUri:url5 delegate:self];
}
[_conn start];
id&lt;RMQChannel&gt; ch = [_conn createChannel];
RMQExchange *x = [ch  direct:@"Mobile_Electric_Alarm" options:(RMQExchangeDeclareNoOptions)];
RMQQueue *q = [ch queue:@"" options:RMQQueueDeclareExclusive | RMQQueueDeclareAutoDelete];
[q bind:x routingKey:kUserInfo.company_id];
kweakSelf;
[q subscribe:^(RMQMessage * _Nonnull message) {
id result = [[NSString alloc] initWithData:message.body encoding:NSUTF8StringEncoding];
NSDictionary *dict = [self dictionaryWithJsonString:result];
if ([dict isKindOfClass:[NSDictionary class]]) {
weakSelf.alarmModel = [LXCustomAlarmModel mj_objectWithKeyValues:dict];
[weakSelf registerNotification:1];
}
}];
}

- (void)emitLogDirect:(NSString *)msg severity:(NSString *)severity {
//    NSString *url5 = @"amqp://web_user:123@192.178.0.2:5672/device_log_2";
DebugLog(@"MQ发送服务器地址:%@",url5);
RMQConnection *conn = [[RMQConnection alloc] initWithUri:url5 delegate:self];
self.conn = conn;
[conn start];
id&lt;RMQChannel&gt; ch = [conn createChannel];
RMQExchange *x = [ch  direct:@"Mobile_Electric_Alarm" options:(RMQExchangeDeclareNoOptions)];
RMQQueue *q = [ch queue:@"" options:RMQQueueDeclareExclusive | RMQQueueDeclareAutoDelete];
[q bind:x routingKey:kUserInfo.company_id];
[x publish:[msg dataUsingEncoding:NSUTF8StringEncoding] routingKey:severity];
NSLog(@"Sent '%@'", msg);
[conn close];
}

#pragma mark - 系统的通知监听
- (void)activeNotification:(NSNotification *)notification{
if (_conn == nil) {
//登录成功
if ([[LXUserInfoManger shareLXUserInfoManger].currentUserInfo.is_cloud isEqualToString:@"0"]) {
//MQ推送
[self receiveRabbitServicerMessage];
}
}
}
- (void)backgroundNotification:(NSNotification *)notification{
[self closeConnection];
}

- (void)connection:(RMQConnection *)connection failedToConnectWithError:(NSError *)error {
if (error) {
NSLog(@"%@",error);
NSLog(@"连接超时");
[self closeConnection];

}else{

}
}
- (void)connection:(RMQConnection *)connection disconnectedWithError:(NSError *)error {
if (error) {
NSLog(@"%@",error);
}
else{
NSLog(@"连接成功");
}
}
- (void)willStartRecoveryWithConnection:(RMQConnection *)connection {
DebugLog(@"将要开始恢复链接");
}
- (void)startingRecoveryWithConnection:(RMQConnection *)connection {
DebugLog(@"开始恢复链接");

}

- (void)recoveredConnection:(RMQConnection *)connection {
DebugLog(@"恢复链接");

}
- (void)channel:(id&lt;RMQChannel&gt;)channel error:(NSError *)error {
if (error) {
NSLog(@"%@",error);
[self closeConnection];
}
}

//获取当前屏幕显示的viewcontroller，当接收到推送需要跳转VC
- (UIViewController *)getCurrentVC {
UIViewController *rootViewController = [UIApplication sharedApplication].keyWindow.rootViewController;
UIViewController *currentVC = [self getCurrentVCFrom:rootViewController];
return currentVC;
}

- (UIViewController *)getCurrentVCFrom:(UIViewController *)rootVC {
UIViewController *currentVC;
if ([rootVC presentedViewController]) {
// 视图是被presented出来的
rootVC = [rootVC presentedViewController];
}
if ([rootVC isKindOfClass:[UITabBarController class]]) {
// 根视图为UITabBarController
currentVC = [self getCurrentVCFrom:[(UITabBarController *)rootVC selectedViewController]];

} else if ([rootVC isKindOfClass:[UINavigationController class]]){
// 根视图为UINavigationController
currentVC = [self getCurrentVCFrom:[(UINavigationController *)rootVC visibleViewController]];

} else {
// 根视图为非导航类
currentVC = rootVC;
}
return currentVC;
}
//接收到推送，json格式字符串转字典：因为MQ推过来的消息是 String 类型的
- (NSDictionary *)dictionaryWithJsonString:(NSString *)jsonString {

if (jsonString == nil) {
return nil;
}
NSData *jsonData = [jsonString dataUsingEncoding:NSUTF8StringEncoding];
NSError *err;
NSDictionary *dic = [NSJSONSerialization JSONObjectWithData:jsonData
options:NSJSONReadingMutableContainers
error:&amp;err];
if(err) {
NSLog(@"json解析失败：%@",err);
return nil;
}
return dic;

}
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="23-本地安装启动mq服务">2.3 本地安装启动MQ服务</h3>

<p>如果电脑安装 brew 软件包工具的话，执行并启动</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>brew install rabbitmq

sudo ./rabbitmq-server

</pre></td></tr></tbody></table></code></pre></div></div>
<p>浏览器访问:localhost:15672,默认账号为:guest 密码: guest</p>

<h2 id="三rabbitmq-遇到的问题">三.RabbitMQ 遇到的问题</h2>

<h3 id="31-地址不对connect-fail">3.1 地址不对，connect fail</h3>
<blockquote>
  <p>Received connection: &lt;RMQConnection: 0x103fa1fc0&gt; disconnectedWithError: Error Domain=GCDAsyncSocketErrorDomain Code=7 “Socket closed by remote peer” UserInfo={NSLocalizedDescription=Socket closed by remote peer}</p>
</blockquote>

<p>解决办法：MQ的鉴权，O-C跟Java的格式不太一样，Java是通过Name,Host,Ip等，iOS的是直接设置地址</p>

<blockquote>
  <p>amqps://user:pass@hostname:1234/myvhost</p>
</blockquote>

<p><strong>说明：</strong></p>

<ul>
  <li>协议头：如果是Https的话，协议用：amqps，如果是Http，用amqp</li>
  <li>用户名：userName</li>
  <li>用户密码：password</li>
  <li>ip地址：182.142.123等</li>
  <li>port端口：5672</li>
  <li>虚拟主机：由后台定义，可有可无，根据需求，myloghost</li>
</ul>

<h3 id="32-服务端与客户端参数配置有误消息队列持久化">3.2 服务端与客户端参数配置有误,消息队列持久化</h3>

<blockquote>
  <p>Error Domain=com.rabbitmq.rabbitmq-objc-client Code=406 “PRECONDITION_FAILED - inequivalent arg ‘durable’ for queue ‘Mobile_Electric_Alarm’ in vhost ‘device_log_2’: received ‘false’ but current is ‘true’” UserInfo={NSLocalizedDescription=PRECONDITION_FAILED - inequivalent arg ‘durable’ for queue ‘Mobile_Electric_Alarm’ in vhost ‘device_log_2’: received ‘false’ but current is ‘true’}</p>
</blockquote>

<p>看3.3解决办法</p>

<h3 id="33-mq-找不到对应的队列">3.3 MQ 找不到对应的队列</h3>

<blockquote>
  <p>Error Domain=com.rabbitmq.rabbitmq-objc-client Code=404 “NOT_FOUND - no queue ‘rmq-objc-client.gen-3B6E0E14-06E6-4AFC-B6E1-42A7F8FCD218-46927-00002C8AE36AB350’ in vhost ‘device_log_2’” UserInfo={NSLocalizedDescription=NOT_FOUND - no queue ‘rmq-objc-client.gen-3B6E0E14-06E6-4AFC-B6E1-42A7F8FCD218-46927-00002C8AE36AB350’ in vhost ‘device_log_2’}</p>
</blockquote>

<p>解决办法：</p>

<p>Exchange 交换器的配置参数，跟后台约定的不一致，有时候后台也不知道自己配置的啥，就需要尝试了；</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre>/**

typedef NS_OPTIONS(NSUInteger, RMQExchangeDeclareOptions) {
RMQExchangeDeclareNoOptions  = 0,
/// 被动声明
RMQExchangeDeclarePassive    = 1 &lt;&lt; 0,
///交换器持久化
RMQExchangeDeclareDurable    = 1 &lt;&lt; 1,
/// 自动销毁交换器，当所有的消息队列都被使用
RMQExchangeDeclareAutoDelete = 1 &lt;&lt; 2,
/// 配置的交换器内部构造对应用发布者不可见
RMQExchangeDeclareInternal   = 1 &lt;&lt; 3,
/// @brief
RMQExchangeDeclareNoWait     = 1 &lt;&lt; 4,
};*/
RMQExchange *x = [ch  direct:@"Mobile_Electric_Alarm" options:(RMQExchangeDeclareNoOptions)];
/** 
* 队列的配置可选参数
* 
typedef NS_OPTIONS(NSUInteger, RMQQueueDeclareOptions) {
RMQQueueDeclareNoOptions  = 0,
/// 被动声明
RMQQueueDeclarePassive    = 1 &lt;&lt; 0,
/// 队列持久化
RMQQueueDeclareDurable    = 1 &lt;&lt; 1,
/// 只能被当前的连接授权访问
RMQQueueDeclareExclusive  = 1 &lt;&lt; 2,
/// 自动删除
RMQQueueDeclareAutoDelete = 1 &lt;&lt; 3,
///
RMQQueueDeclareNoWait     = 1 &lt;&lt; 4,
};
*/
RMQQueue *q = [ch queue:@"" options:RMQQueueDeclareExclusive | RMQQueueDeclareAutoDelete];


</pre></td></tr></tbody></table></code></pre></div></div>

<p>如果连接成功后，那么在MQ的管理台，就可以看到当前连接的消费者了</p>

<p><img src="http://o9zpq25pv.bkt.clouddn.com/%E5%9B%BE%E7%89%87.png" alt="管理台当前连接消费者" /></p>

<p>[参考文章]</p>

<p>1&gt; <a href="https://www.rabbitmq.com/tutorials/tutorial-one-objectivec.html">RabbbitMQ官网</a></p>

<p>2&gt; <a href="http://www.diggerplus.org/archives/3110">RabbitMQ基础概念详细介绍</a></p>

<p>3&gt; <a href="https://www.jianshu.com/p/79ca08116d57">消息队列之 RabbitMQ</a></p>

<p>4&gt; <a href="https://www.jianshu.com/p/5c2d8af2c78e">RabbitMQ——第一篇：RabbitMQ介绍</a></p>

<h2 id="交流讨论">交流讨论</h2>

<p>RabbitMQ在iOS中的使用资料很少，如果有问题的话，欢迎留言探讨，也可以加我QQ:1093034974</p>

<p>另外，如果你觉得我的文章对你有一定的帮助，非常感谢能够点赞，谢谢！</p>


                <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a></div>
                <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["weixin","qzone","tsina","tqq","twi","fbook"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["weixin","qzone","tsina","tqq","twi","fbook"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

                <hr style="visibility: hidden;">

            <!-- 打赏功能 -->
            <div>
                <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
                <div>☛兄dei，请我喝杯茶☚</div>
                <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
                    <span>打赏</span>
                </button>
                <div id="QR" style="display: none;">
                        
                        
                <div id="wechat" style="display: inline-block">
                <img id="wechat_qr" src="/img/payimg/weipayimg.jpg" alt="yizibi 微信支付"/>
                            <p>微信支付</p>
                </div>
                        
                        
                        
                <div id="alipay" style="display: inline-block">
                <img id="alipay_qr" src="/img/payimg/alipayimg.jpg" alt="yizibi 支付宝"/>
                <p>支付宝</p>
                </div>
                        
                        
                        
                        
                </div>
                </div>
                
            </div>
            

   <!--  上一篇或者下一篇post按钮 -->
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2018/07/15/Mac-%E7%94%9F%E6%88%90%E7%9B%AE%E5%BD%95%E6%A0%91%E7%BB%93%E6%9E%84/" data-toggle="tooltip" data-placement="top" title="Mac 生成目录树结构">
                        Previous<br>
                        <span>Mac 生成目录树结构</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2018/09/10/iOS%E7%BB%99%E4%B8%80%E5%BC%A0%E5%9B%BE%E7%89%87%E6%B7%BB%E5%8A%A0%E5%B8%A6%E6%9C%89%E9%9B%B7%E8%BE%BE%E6%95%88%E6%9E%9C%E7%9A%84%E6%A0%87%E8%AE%B0-%E7%B1%BB%E4%BC%BC%E5%9C%B0%E5%9B%BE%E6%A0%87%E8%AE%B0%E4%BD%8D%E7%BD%AE/" data-toggle="tooltip" data-placement="top" title="iOS给一张图片添加带有雷达效果的标记，类似地图标记位置">
                        Next<br>
                        <span>iOS给一张图片添加带有雷达效果的标记，类似地图标记位置</span>
                        </a>
                    </li>
                    
                </ul>


<!--                -->

                
                
                <!--   gitalk       -->
                
            </div>  

    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
        				
                            
                				<a href="/tags/#iOS技术" title="iOS技术" rel="13">
                                    iOS技术
                                </a>
                            
        				
                            
                				<a href="/tags/#iOS问题" title="iOS问题" rel="2">
                                    iOS问题
                                </a>
                            
        				
                            
                				<a href="/tags/#VPS" title="VPS" rel="2">
                                    VPS
                                </a>
                            
        				
                            
                				<a href="/tags/#工具" title="工具" rel="6">
                                    工具
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#生活" title="生活" rel="3">
                                    生活
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#Linux" title="Linux" rel="2">
                                    Linux
                                </a>
                            
        				
                            
                				<a href="/tags/#博客" title="博客" rel="3">
                                    博客
                                </a>
                            
        				
                            
                				<a href="/tags/#随笔" title="随笔" rel="2">
                                    随笔
                                </a>
                            
        				
                            
                				<a href="/tags/#摄影" title="摄影" rel="2">
                                    摄影
                                </a>
                            
        				
                            
                				<a href="/tags/#旅行" title="旅行" rel="2">
                                    旅行
                                </a>
                            
        				
        			</div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">
                    
                        <li><a href="https://blog.searchinfogo.com">Junhua's Blog</a></li>
                    
                        <li><a href="http://ilongge.cn/">卟败灬筱龙</a></li>
                    
                        <li><a href="http://tombraiderjf.com/">Lara Croft</a></li>
                    
                        <li><a href="http://srsyrzz.ml/">耀日庄主的博客</a></li>
                    
                        <li><a href="https://leohope.com/">Hope</a></li>
                    
                        <li><a href="https://www.chairyfish.com/">五斤</a></li>
                    
                        <li><a href="https://asdfv1929.github.io/">asdfv1929</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
    

    
</article>


<!-- Add support for Mathjax by Voleking-->




<section class="post-comments">
    
    <div id="disqus_thread"></div>
    <script>
        
        var disqus_config = function () {
            this.page.url = "http://localhost:4000/2018/08/14/RabbitMQ%E5%9C%A8iOS%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/";
            this.page.identifier = "/2018/08/14/RabbitMQ%E5%9C%A8iOS%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/";
        };
    
    var disqus_shortname = 'yizibi';
    
    (function() { // DON'T EDIT BELOW THIS LINE
     var d = document, s = d.createElement('script');
     s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
     s.setAttribute('data-timestamp', +new Date());
     (d.head || d.body).appendChild(s);
     })();
        </script>
    <noscript>要查看<a href="http://disqus.com/?ref_noscript"> Disqus </a>评论，请启用 JavaScript</noscript>
    
    
    
    
    
</section>







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<!--
Author: Ray-Eldath
refer to:
 - https://github.com/theme-next/hexo-theme-next/blob/master/source/js/src/utils.js
 - https://jingyan.baidu.com/article/b2c186c83ec846c46ef6ff80.html
 - http://www.bkjia.com/jQuery/449205.html
-->
<style media="screen">
  .scroll {
    z-index: 10000;
    display: none;
    height: 24px;
    background: #222;
    color: #fff;
    line-height: 24px;
    text-align: center;
    position: fixed;
    right: 30px;
    bottom: 30px;
    cursor: pointer;
    font-size: 14px;
  }
</style>
<div class="scroll">
  <i class="fa fa-arrow-up" style="margin-left: 4px"></i>
  <span class="scrollpercent" style="margin-left: -2px"></span>
  <span style="margin-left: -4px; margin-right: 4px">%</span>
</div>

<script src="/js/util.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    if (utils.isMobile()) {
      $('.scroll').hide();
      return;
    }
    $(window).scroll(function() {
      let scrollValue = $(window).scrollTop();
      var scrollPercentRounded = Math.round((scrollValue / utils.getContentVisibilityHeight()) * 100);
      var scrollPercentMaxed = (scrollPercentRounded > 100) ? 100 : scrollPercentRounded;
      $('.scrollpercent').html(scrollPercentMaxed);
      scrollValue > 100 ? $('.scroll').fadeIn() : $('.scroll').fadeOut();
    });
    $('.scroll').click(function() {
      $('html, body').animate({
        scrollTop: 0
      }, 300);
    })
  })
</script>


<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://twitter.com/yizibi">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/li-lin-fei">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="http://weibo.com/2524618644">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    


                    
                    <li>
                        <a target="_blank" href="https://www.facebook.com/yizibbi">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/yizibi">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/露鑫-李-525b58111">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">
<!--                  本站总访问量<span id="busuanzi_value_site_pv"></span>次，本站访客数<span id="busuanzi_value_site_uv"></span>人次，本文总阅读量<span id="busuanzi_value_page_pv"></span>次-->
                    <span class="site-uv" title="总点击人数">
                    <img src="/img/vendor/octicons/svg/person.svg" width="10" height="16">
                    <span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
                    &nbsp;&nbsp;|&nbsp;&nbsp;
                    <span class="site-pv" title="总点击量">
                    <img src="/img/vendor/octicons/svg/eye.svg" width="16" height="16">
                    <span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
                    &nbsp;&nbsp;|&nbsp;&nbsp;
                    <span class="page-pv"title="本页面点击人数">
                    <img src="/img/vendor/octicons/svg/file-text.svg" width="12" height="16">
                    <span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span>
                    <br>
                    Copyright &copy; 一之笔 2018
                    <br>
                    Theme by <a href="https://github.com/Huxpro/huxpro.github.io">Hux</a> | 本站源码 <a href="https://github.com/yizibi/yizibi.github.io">yizibi</a>
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=yizibi&repo=yizibi.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
            
        </div>
    </div>
</footer>
<!--网站统计-->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Service Worker -->


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async('/js/jquery.tagcloud.js',function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-124793396-1';
    var _gaDomain = 'auto';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->



<!-- Side Catalog -->



<!-- Multi-Lingual -->




<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

<script src="/js/jquery.min.js"></script>
<style>
.videoWrapper {
	position: relative;
	padding-bottom: 56.333%;
	height: 0;
    background: black;
}
.videoWrapper iframe {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
    border: 0;
}    
</style>

<script>
function get_youtube_id(url) {
    var p = /^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;
    return (url.match(p)) ? RegExp.$1 : false;
}
function vimeo_embed(url,el) {
    var id = false;
    $.ajax({
      url: 'https://vimeo.com/api/oembed.json?url='+url,
      async: true,
      success: function(response) {
        if(response.video_id) {
          id = response.video_id;
          if(url.indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
          if(url.indexOf('loop=1') !== -1) var loop=1; else var loop=0;
          var theInnerHTML = '<div class="videoWrapper"><iframe src="https://player.vimeo.com/video/'+id+'/?byline=0&title=0&portrait=0';
          if(autoplay==1) theInnerHTML += '&autoplay=1';
          if(loop==1) theInnerHTML += '&loop=1';
          theInnerHTML += '" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>'; 
          el.innerHTML = theInnerHTML;
        }
      }
    });
}
function video_embed() {
    var p = document.getElementsByTagName('p');
    for(var i = 0; i < p.length; i++) {
        //check if this is an external url (that starts with https:// or http://
        if (p[i].innerHTML.indexOf("http://") == 0 ||
            p[i].innerHTML.indexOf("https://") == 0) {
            var youtube_id = get_youtube_id(p[i].innerHTML);
            if(youtube_id) {
                if(p[i].innerHTML.indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
                if(p[i].innerHTML.indexOf('loop=1') !== -1) var loop=1; else var loop=0;
                var theInnerHTML = '<div class="videoWrapper"><iframe width="720" height="420" src="https://www.youtube.com/embed/' + youtube_id + '?rel=0&showinfo=0';
                if(autoplay==1) theInnerHTML += '&autoplay=1';
                if(loop==1) theInnerHTML += '&loop=1&playlist='+youtube_id+'&version=3';
                theInnerHTML += '" frameborder="0" allowfullscreen></iframe></div>';
                p[i].innerHTML = theInnerHTML;
            }
            if(p[i].innerHTML.indexOf('vimeo.com') !== -1) {
                //ask vimeo for the id and place the embed
                vimeo_embed(p[i].innerHTML,p[i]);
            }
        }
    }
}
video_embed();

function mp3_embed() {
    var p = document.getElementsByTagName('p');
    for(var i = 0; i < p.length; i++) {
        if(p[i].innerHTML.indexOf('.mp3') !== -1) {
            var str = p[i].innerHTML.split('?');
            if(str.length == 1) str[1] = '';
            var str1 = str[1];
            str1 = str1.replace('&','').replace('&','');
            str1 = str1.replace('autoplay=1','').replace('autoplay=0','');
            str1 = str1.replace('loop=1','').replace('loop=0','');
            str1 = str1.replace('controls=0','').replace('controls=1','');

            if (str[0].lastIndexOf('.mp3', str[0].length - 4) === str[0].length - 4 && str1.length == 0) {
                if(str[1].indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
                if(str[1].indexOf('loop=1') !== -1) var loop=1; else var loop=0;
                if(str[1].indexOf('controls=0') !== -1) var controls=0; else var controls=1;
                var newInnerHTML = '<audio';
                if(autoplay==1) newInnerHTML += ' autoplay';
                if(loop==1) newInnerHTML += ' loop';
                if(controls==1) newInnerHTML += ' controls';
                newInnerHTML += '><source src="'+str[0]+'" type="audio/mpeg">Your browser does not support the audio element.</audio>';
                p[i].innerHTML = newInnerHTML;
            }
        }
    }
}
mp3_embed();
</script>

<!--鼠标点击爱心动画-->
<script type="text/javascript" src="/js/src/love.js"></script>

</body>

</html>
